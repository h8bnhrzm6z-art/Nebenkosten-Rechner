<!DOCTYPE html>
<html lang="de" data-theme="neo">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alexander sein Nebenkosten (v5)</title>
<style>
/* =========================
   Modern & bunt (v5)
   ========================= */
:root{
  --bg0:#0b1020;
  --bg1:#070a14;
  --card: rgba(255,255,255,.08);
  --card2: rgba(255,255,255,.10);
  --stroke: rgba(255,255,255,.14);
  --text:#eaf0ff;
  --muted: rgba(234,240,255,.72);

  --primary:#7c5cff;
  --primary2:#2dd4bf;
  --pink:#ff4fd8;
  --amber:#ffcc66;
  --danger:#ff5a6a;
  --success:#2ee59d;

  --shadow: 0 18px 50px rgba(0,0,0,.45);
  --shadow2: 0 10px 24px rgba(0,0,0,.35);
  --radius: 18px;
  --radius2: 14px;

  --gap: 14px;
  --pad: 14px;

  --input-bg: rgba(255,255,255,.10);
  --input-stroke: rgba(255,255,255,.18);
  --focus: 0 0 0 4px rgba(124,92,255,.25);
}

@media (prefers-color-scheme: light){
  :root{
    --bg0:#f6f7ff;
    --bg1:#ffffff;
    --card: rgba(255,255,255,.9);
    --card2: rgba(255,255,255,.98);
    --stroke: rgba(20,25,45,.10);
    --text:#0f1430;
    --muted: rgba(15,20,48,.70);
    --shadow: 0 18px 45px rgba(15,20,48,.10);
    --shadow2: 0 10px 20px rgba(15,20,48,.08);
    --input-bg: rgba(15,20,48,.04);
    --input-stroke: rgba(15,20,48,.10);
    --focus: 0 0 0 4px rgba(124,92,255,.18);
  }
}

*{box-sizing:border-box}
html,body{min-height:100%;}
body{
  margin:0;
  min-height:100vh;
  height:auto;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--text);
  background:
    radial-gradient(1100px 700px at 18% 14%, rgba(124,92,255,.35), transparent 55%),
    radial-gradient(900px 650px at 85% 25%, rgba(45,212,191,.30), transparent 60%),
    radial-gradient(900px 650px at 55% 95%, rgba(255,79,216,.22), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  background-attachment: fixed;
  background-repeat: no-repeat;
  background-size: cover;
}


a{color:inherit}

.wrap{
  max-width: 1160px;
  margin: 0 auto;
  padding: 22px 16px calc(220px + env(safe-area-inset-bottom));
}

.hero{
  display:flex;
  gap: 14px;
  align-items:flex-end;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom: 14px;
}
.brand{
  display:flex; gap:12px; align-items:center;
}
.logo{
  width:46px;height:46px;border-radius:16px;
  background: linear-gradient(135deg, var(--primary), var(--primary2));
  box-shadow: 0 12px 30px rgba(124,92,255,.35);
  position:relative;
}
.logo:after{
  content:"";
  position:absolute; inset:10px 12px 12px 10px;
  border-radius:12px;
  background: linear-gradient(135deg, rgba(255,255,255,.70), rgba(255,255,255,.15));
  mix-blend-mode: overlay;
}
h1{
  margin:0;
  font-size: 1.5rem;
  letter-spacing:-.02em;
  line-height:1.15;
}
.subhead{
  margin:.3rem 0 0 0;
  color:var(--muted);
  font-size:.95rem;
  max-width: 820px;
}
.chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
.chip{
  display:inline-flex; gap:8px; align-items:center;
  padding: .35rem .6rem;
  border-radius: 999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.06);
  backdrop-filter: blur(10px);
  font-size:.88rem;
  color: var(--muted);
}
.dot{width:8px;height:8px;border-radius:999px; background: var(--primary2);}
.dot.p{background: var(--primary);}
.dot.a{background: var(--amber);}
.dot.r{background: var(--danger);}

.notice{
  display:none;
  margin: 12px 0 14px;
  border-radius: var(--radius);
  padding: 12px 14px;
  border:1px solid rgba(255,90,106,.35);
  background: linear-gradient(135deg, rgba(255,90,106,.20), rgba(255,79,216,.08));
  box-shadow: var(--shadow2);
}
.notice strong{display:block;margin-bottom:.25rem;}
.notice ul{margin:.35rem 0 0 1.1rem;}
.notice li{margin:.15rem 0;color:var(--muted);}
.notice .hint{color:var(--muted)}

.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: var(--gap);
}
@media(min-width: 920px){
  .grid{grid-template-columns: .95fr 1.05fr;}
}

.card{
  border-radius: var(--radius);
  border: 1px solid var(--stroke);
  background: linear-gradient(180deg, var(--card2), var(--card));
  box-shadow: var(--shadow);
  overflow:hidden;
}

.cardHeader{
  padding: 14px 14px 10px;
  display:flex; align-items:flex-end; justify-content:space-between;
  gap: 12px; flex-wrap:wrap;
}
.cardHeader h2{
  margin:0;
  font-size: 1.05rem;
  letter-spacing:-.01em;
}
.cardHeader p{
  margin:.15rem 0 0 0;
  color:var(--muted);
  font-size:.9rem;
}
.cardBody{padding: 0 14px 14px;}

.divider{
  height:1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
  margin: 8px 0 10px;
}

label{
  display:block;
  margin-top: 10px;
  font-weight: 700;
  font-size: .92rem;
}

/* Kompaktere Eingaben + Einheiten im Feld (rechts) */
.row{ gap:10px; }
.formGrid{ gap:10px 12px; }

/* allgemein etwas weniger Luft zwischen Feldern */
label{ margin-top: 8px; position: relative; }
.small{ margin-top: .25rem; }

/* kleinere Feldhöhe */
input[type="number"], input[type="date"], select, textarea{
  height: 40px;
  padding: 8px 10px;
  border-radius: 14px;
}

/* Einheit als Suffix im Eingabefeld */
.unit{
  position: absolute;
  right: 14px;
  /* liegt auf Höhe des Inputs (Label-Text + Abstand + halbe Input-Höhe) */
  top: 52px;
  transform: translateY(-50%);
  color: var(--muted);
  font-weight: 900;
  font-size: .92rem;
  pointer-events: none;
  white-space: nowrap;
  opacity: .9;
}

/* Platz schaffen, damit Text nicht unter die Einheit läuft */
label input[type="number"]{ padding-right: 78px; }

/* Wenn eine Fehlermeldung direkt nach dem Input kommt, bleibt alles sauber */
.error-msg{ margin-top: 6px; }

/* Kompakter „Settings“-Block (Rechenmodus, Brennwert, Zustandszahl, Gas-Faktor) */
.settingsCompact .row{ margin-top: 6px; }
.settingsCompact label{ margin-top: 6px; font-weight: 800; }
.settingsCompact .small{ margin-top: .25rem; font-size: .82rem; line-height: 1.25; }
.settingsCompact input[type="number"],
.settingsCompact input[type="date"],
.settingsCompact select{
  height: 40px;
  padding: 8px 10px;
  border-radius: 14px;
}
.settingsCompact .unit{ margin-top: 6px; font-size: .9rem; }
.settingsCompact .error-msg{ margin-top: 6px; }
.small{
  display:block;
  margin-top: .25rem;
  font-weight: 500;
  color: var(--muted);
  font-size: .84rem;
}

.row{
  display:flex;
  gap: 12px;
  flex-wrap:wrap;
  align-items:flex-end;
}
.formGrid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:14px 16px;
  align-items:start;
}
@media (max-width: 820px){
  .formGrid{ grid-template-columns: 1fr; }

/* Kompakter Block: Neuer Zählerstand + Datum nebeneinander, Abschlag darunter */
.readingGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px 12px;
  align-items:start;
}
.readingGrid .full{ grid-column: 1 / -1; }
@media (max-width: 640px){
  .readingGrid{ grid-template-columns: 1fr; }
  .readingGrid .full{ grid-column: auto; }
}
}

.row > label{flex:1; min-width: 240px;}

input[type="number"], input[type="date"], select{
  width:100%;
  height: 44px;
  padding: 10px 12px;
  margin-top: 8px;
  border-radius: 14px;
  border: 1px solid var(--input-stroke);
  background: var(--input-bg);
  color: var(--text);
  outline: none;
}
input[readonly]{opacity:.85}
input:focus, select:focus{
  box-shadow: var(--focus);
  border-color: rgba(124,92,255,.55);
}
input.invalid, select.invalid{
  border-color: rgba(255,90,106,.65);
  background: rgba(255,90,106,.10);
}
.error-msg{
  color: rgba(255,90,106,.95);
  font-size: .84rem;
  min-height: 1.05rem;
  margin-top: .25rem;
}

.unit{
  margin-left: .45rem;
  color: var(--muted);
  font-size: .88rem;
  font-weight: 700;
}

/* Tabs */
.tabs{
  display:flex;
  gap: 8px;
  flex-wrap:wrap;
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
.tabBtn{
  appearance:none;border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--muted);
  padding: .5rem .75rem;
  border-radius: 999px;
  cursor:pointer;
  font-weight: 800;
  letter-spacing: .01em;
}
.tabBtn[aria-selected="true"]{
  color: var(--text);
  border-color: rgba(124,92,255,.55);
  background:
    linear-gradient(135deg, rgba(124,92,255,.35), rgba(45,212,191,.18));
  box-shadow: 0 10px 22px rgba(124,92,255,.18);
}
.tabPanel{display:none;}
.tabPanel.active{display:block;}

/* Tariffs */
.tariffs{
  margin-top: 12px;
  padding: 12px 12px;
  border-radius: var(--radius2);
  border: 1px dashed rgba(124,92,255,.35);
  background: rgba(124,92,255,.06);
}
.tariffs h3{
  margin:0;
  font-size:.96rem;
}
.tariffs .controls{
  display:flex;
  gap: 10px;
  flex-wrap:wrap;
  align-items:center;
  margin-top: 10px;
}
.tariffs table{
  width:100%;
  border-collapse: collapse;
  margin-top: 10px;
  overflow:hidden;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
}
.tariffs th, .tariffs td{
  padding: .5rem .55rem;
  border-bottom: 1px solid rgba(255,255,255,.08);
  text-align:left;
  vertical-align:top;
  font-size: .9rem;
}
.tariffs th{color:var(--muted); font-weight: 800;}
.tariffs td.num{text-align:right; font-variant-numeric: tabular-nums;}
.tariffs input{height:40px;border-radius:12px;margin-top:0;}
.tariffs button{margin-top:0;}

#exportScope{
  height:44px;
}
@media (max-width: 560px){
  #exportScope{ width:100%; }
}

/* Preview */
.preview{
  margin-top: 12px;
  padding: 12px 12px;
  border-radius: var(--radius2);
  background:
    radial-gradient(700px 280px at 0% 0%, rgba(45,212,191,.18), transparent 60%),
    radial-gradient(700px 280px at 100% 0%, rgba(124,92,255,.20), transparent 60%),
    rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.10);
}
.kpis{display:flex; gap:8px; flex-wrap:wrap;}
.kpi{
  display:inline-flex; gap:8px; align-items:center;
  padding: .28rem .6rem;
  border-radius: 999px;
  font-size: .88rem;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--muted);
}
.kpi strong{color: var(--text);}

.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding: .3rem .6rem;
  border-radius: 999px;
  font-size: .88rem;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,.14);
}
.badge.red{background: rgba(255,90,106,.16); color: #ffd1d6; border-color: rgba(255,90,106,.28);}
.badge.green{background: rgba(46,229,157,.14); color: #c9ffe8; border-color: rgba(46,229,157,.26);}
.badge.gray{background: rgba(255,255,255,.08); color: var(--muted);}

.result{display:none;margin-top: var(--gap);  overflow-x: auto;
}

.resultHeader{
  padding: 12px 14px;
  display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;
}
.resultHeader h2{margin:0;font-size:1.05rem;}
.resultHeader .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:.9rem;}
.summaryBar{
  display:flex; gap: 10px; flex-wrap:wrap;
  padding: 0 14px 14px;
}
.summaryBar{
  display:grid;
  gap: 10px;
  padding: 0 14px 14px;
  grid-template-columns: 1fr;
}
@media (min-width: 900px){
  .summaryBar{
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}
.summaryTile{ min-height: 92px; 
  min-width:0;
}
.summaryTile .t,
.summaryTile .s{word-break: break-word;}

.summaryTile .v{ font-size:1.1rem; }
.summaryTile.primary .v{ font-size:1.25rem; }

/* Details/Accordion */
details{
  margin: 0 14px 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  overflow:hidden;
}
details > summary{
  cursor:pointer;
  padding: 10px 12px;
  font-weight: 950;
  list-style:none;
}
details > summary::-webkit-details-marker{ display:none; }
details[open] > summary{
  border-bottom: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
details .inner{ padding: 10px 12px; }
.summaryTile{
  flex: 1;
  min-width: 220px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  padding: 10px 12px;
}
.summaryTile .t{color:var(--muted);font-weight:800;font-size:.85rem;}
.summaryTile .v{font-size:1.15rem;font-weight: 950;letter-spacing:-.02em;margin-top:.15rem;}
.summaryTile .s{color:var(--muted);font-size:.86rem;margin-top:.15rem;line-height:1.25;}
.summaryTile.primary{
  background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(45,212,191,.10));
  border-color: rgba(124,92,255,.30);
}

.cards{
  display:grid;
  gap: 12px;
  grid-template-columns: 1fr;
  padding: 0 14px 14px;
}
@media(min-width:920px){ .cards{grid-template-columns: repeat(3, 1fr);} }

.miniCard{
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  padding: 12px 12px;
}

/* Badges (kWh / Tage) etwas kleiner & ruhiger */
.pill, .badge{
  font-size: .85rem;
  padding: 4px 10px;
}


/* === Lösung A: Einzelergebnisse – bessere Typo & Umbruch === */
.miniCard{
  font-size: .95rem;
}

.miniCard h3{
  font-size: 1rem;
}

.miniCard .kpis{
  font-size: .9rem;
}

.miniCard .line{
  align-items: flex-start;
}

.miniCard .line span{
  font-size: .88rem;
  max-width: 55%;
  white-space: normal;
  line-height: 1.25;
}

.miniCard .line strong{
  font-size: .95rem;
}
.miniCard .kpis{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom: 8px;
}
.miniCard .kpi{
  background: rgba(255,255,255,.05);
}
.line{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding: 6px 0;
  border-bottom: 1px dashed rgba(255,255,255,.10);
}
.line:last-of-type{ border-bottom: none; }
.line span{ color: var(--muted); font-weight: 800; }
.line strong{ font-variant-numeric: tabular-nums; }
.miniCard h3{margin:0 0 8px 0;font-size:1rem;letter-spacing:-.01em;}
.line{display:flex;justify-content:space-between;gap:10px;margin-top:6px;color:var(--muted);font-size:.92rem;}
.line strong{color:var(--text);}

.tableWrap{padding:0 14px 14px;}
table.std{
  width:100%;
  border-collapse: collapse;
  overflow:hidden;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
}
table.std th, table.std td{
  padding: .65rem .75rem;
  border-bottom: 1px solid rgba(255,255,255,.08);
  text-align:left;
}
table.std th{color:var(--muted);font-weight:900;background: rgba(255,255,255,.04);}
table.std td.num{text-align:right;font-variant-numeric: tabular-nums;}

details{
  margin: 12px 14px 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  border-radius: 16px;
  overflow:hidden;
}
summary{
  cursor:pointer;
  padding: 12px 12px;
  font-weight: 900;
  color: var(--text);
  list-style:none;
}
summary::-webkit-details-marker{display:none}
details .inner{padding:0 12px 12px;color:var(--muted);}

/* Sticky actions */
.stickyBar{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  padding: 10px 12px;
  background: linear-gradient(180deg, rgba(7,10,20,0), rgba(7,10,20,.75) 20%, rgba(7,10,20,.92));
  backdrop-filter: blur(12px);
}
@media (prefers-color-scheme: light){
  .stickyBar{
    background: linear-gradient(180deg, rgba(255,255,255,0), rgba(246,247,255,.75) 20%, rgba(246,247,255,.92));
  }
}
.stickyInner{
  max-width: 1160px;
  margin: 0 auto;
  display:flex;
  gap: 10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
.btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
button{
  appearance:none;
  border:none;
  border-radius: 14px;
  padding: 11px 14px;
  height: 44px;
  cursor:pointer;
  font-weight: 950;
  letter-spacing: .01em;
  color: white;
  background: linear-gradient(135deg, var(--primary), #5ad7ff);
  box-shadow: 0 14px 30px rgba(124,92,255,.25);
}
button:hover{filter: brightness(1.03);}
button:active{transform: translateY(1px);}
button.secondary{
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.18);
  color: var(--text);
  box-shadow:none;
}
button.success{
  background: linear-gradient(135deg, var(--success), var(--primary2));
  box-shadow: 0 14px 30px rgba(46,229,157,.18);
}
button.ghost{
  background: transparent;
  border: 1px solid rgba(255,255,255,.18);
  color: var(--text);
  box-shadow:none;
}
button.light{
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.18);
  color: var(--text);
  box-shadow:none;
}
button[disabled]{
  opacity:.55;
  cursor:not-allowed;
  filter:saturate(.6);
  transform:none;
}
.hint{color:var(--muted);font-size:.9rem;}
.rightHint{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:.9rem;}
.rightHint .spark{
  width:10px;height:10px;border-radius:999px;
  background: linear-gradient(135deg, var(--pink), var(--amber));
  box-shadow: 0 0 0 4px rgba(255,79,216,.15);
}

/* Theme switching */
:root{
  transition: background-color .25s ease, color .25s ease;
}
body, .card, input, select, .tabBtn, button, .notice, .preview, .tariffs, table, .miniCard, details, .summaryTile{
  transition: background .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, filter .25s ease;
}

/* ===== Themes (via data-theme) =====
   neo = modern & bunt (default)
   ice = clean/ice
   dark = deep dark
   pastel = soft pastel
   sunset = warm sunset
   mono = minimal mono
*/
:root[data-theme="neo"]{
  --bg0:#0b1020;
  --bg1:#070a14;
  --card: rgba(255,255,255,.08);
  --card2: rgba(255,255,255,.10);
  --stroke: rgba(255,255,255,.14);
  --text:#eaf0ff;
  --muted: rgba(234,240,255,.72);
  --primary:#7c5cff;
  --primary2:#2dd4bf;
  --pink:#ff4fd8;
  --amber:#ffcc66;
  --danger:#ff5a6a;
  --success:#2ee59d;
  --shadow: 0 18px 50px rgba(0,0,0,.45);
  --shadow2: 0 10px 24px rgba(0,0,0,.35);
  --input-bg: rgba(255,255,255,.10);
  --input-stroke: rgba(255,255,255,.18);
  --focus: 0 0 0 4px rgba(124,92,255,.25);
}
:root[data-theme="ice"]{
  --bg0:#f5fbff;
  --bg1:#ffffff;
  --card: rgba(255,255,255,.92);
  --card2: rgba(255,255,255,.98);
  --stroke: rgba(15,35,60,.10);
  --text:#0b1730;
  --muted: rgba(11,23,48,.70);
  --primary:#2563eb;
  --primary2:#06b6d4;
  --pink:#ec4899;
  --amber:#f59e0b;
  --danger:#ef4444;
  --success:#22c55e;
  --shadow: 0 18px 45px rgba(15,30,60,.10);
  --shadow2: 0 10px 20px rgba(15,30,60,.08);
  --input-bg: rgba(11,23,48,.04);
  --input-stroke: rgba(11,23,48,.10);
  --focus: 0 0 0 4px rgba(37,99,235,.18);
}
:root[data-theme="dark"]{
  --bg0:#020617;
  --bg1:#01030a;
  --card: rgba(255,255,255,.06);
  --card2: rgba(255,255,255,.08);
  --stroke: rgba(255,255,255,.12);
  --text:#eef2ff;
  --muted: rgba(238,242,255,.68);
  --primary:#8b5cf6;
  --primary2:#06b6d4;
  --pink:#f472b6;
  --amber:#fbbf24;
  --danger:#fb7185;
  --success:#34d399;
  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --shadow2: 0 10px 28px rgba(0,0,0,.45);
  --input-bg: rgba(255,255,255,.08);
  --input-stroke: rgba(255,255,255,.14);
  --focus: 0 0 0 4px rgba(139,92,246,.22);
}
:root[data-theme="pastel"]{
  --bg0:#fff7fb;
  --bg1:#f6fbff;
  --card: rgba(255,255,255,.88);
  --card2: rgba(255,255,255,.96);
  --stroke: rgba(60,10,40,.10);
  --text:#24102a;
  --muted: rgba(36,16,42,.68);
  --primary:#a78bfa;
  --primary2:#34d399;
  --pink:#fb7185;
  --amber:#fbbf24;
  --danger:#f43f5e;
  --success:#22c55e;
  --shadow: 0 18px 45px rgba(36,16,42,.10);
  --shadow2: 0 10px 20px rgba(36,16,42,.08);
  --input-bg: rgba(36,16,42,.04);
  --input-stroke: rgba(36,16,42,.10);
  --focus: 0 0 0 4px rgba(167,139,250,.18);
}
:root[data-theme="sunset"]{
  --bg0:#120a0b;
  --bg1:#090308;
  --card: rgba(255,255,255,.07);
  --card2: rgba(255,255,255,.10);
  --stroke: rgba(255,255,255,.14);
  --text:#fff1f2;
  --muted: rgba(255,241,242,.70);
  --primary:#fb7185;
  --primary2:#f59e0b;
  --pink:#f472b6;
  --amber:#fbbf24;
  --danger:#ff5a6a;
  --success:#34d399;
  --shadow: 0 18px 55px rgba(0,0,0,.50);
  --shadow2: 0 10px 26px rgba(0,0,0,.42);
  --input-bg: rgba(255,255,255,.08);
  --input-stroke: rgba(255,255,255,.14);
  --focus: 0 0 0 4px rgba(251,113,133,.22);
}
:root[data-theme="mono"]{
  --bg0:#0b0b0c;
  --bg1:#060607;
  --card: rgba(255,255,255,.06);
  --card2: rgba(255,255,255,.08);
  --stroke: rgba(255,255,255,.12);
  --text:#f4f4f5;
  --muted: rgba(244,244,245,.68);
  --primary:#a1a1aa;
  --primary2:#d4d4d8;
  --pink:#a1a1aa;
  --amber:#d4d4d8;
  --danger:#f87171;
  --success:#4ade80;
  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --shadow2: 0 10px 28px rgba(0,0,0,.45);
  --input-bg: rgba(255,255,255,.08);
  --input-stroke: rgba(255,255,255,.14);
  --focus: 0 0 0 4px rgba(161,161,170,.22);
}


/* Theme picker tweaks */
#themeBtn{padding:.5rem .75rem}
#themeBtn[data-open="true"] #gearIcon{transform: rotate(25deg);}
#gearIcon{transition: transform .25s ease;}
.themeChoice{
  width:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  padding:12px 12px;

  /* wichtig: globales button{height:44px} überschreiben */
  height:auto;
  min-height:110px;

  /* Layout: nichts wird abgeschnitten */
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:flex-start;
  gap:4px;

  cursor:pointer;
  text-align:left;
}

.themeChoice:hover{filter:brightness(1.04);}
.themeChoice .name{font-weight:950; line-height:1.15;}
.themeChoice .desc{max-width:100%;}
.themeChoice .swatches{margin-top:8px; flex-shrink:0; flex-wrap:wrap;}

.themeChoice .desc{color:var(--muted);font-size:.85rem;margin-top:.15rem;line-height:1.25;}
.swatches{display:flex;gap:6px;margin-top:8px;}
.sw{width:14px;height:14px;border-radius:6px;border:1px solid rgba(255,255,255,.18);}


/* =========================
   Responsive improvements (v7)
   ========================= */

/* Better spacing on small screens */
@media (max-width: 520px){
  .wrap{padding: 18px 12px 130px;}
  h1{font-size: 1.35rem;}
  .subhead{font-size:.92rem;}
  .chips{gap:6px;}
  .chip{font-size:.84rem;padding:.3rem .55rem;}
  .cardHeader{padding: 12px 12px 8px;}
  .cardBody{padding: 0 12px 12px;}
  .tabs{padding: 10px 12px;}
  label{font-size:.9rem;}
  input[type="number"], input[type="date"], select{border-radius: 12px;}
}

/* Make the left/right layout feel better on wide screens */
@media (min-width: 1200px){
  .grid{grid-template-columns: .9fr 1.1fr;}
}

/* Tables: allow horizontal scroll on narrow devices */
.tariffs{overflow-x:auto; -webkit-overflow-scrolling: touch;}
.tariffs table{min-width: 680px;}
.tableWrap{overflow-x:auto; -webkit-overflow-scrolling: touch;}
table.std{min-width: 760px;}

/* Keep important UI reachable on phones with notches */
.stickyBar{
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
}
.wrap{padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));}

/* Theme panel as bottom sheet on small screens */
#themePanel{
  /* allow CSS overrides even though it has inline styles */
  right: 18px;
  top: 76px;
}
@media (max-width: 520px){
  #themePanel{
    left: 12px !important;
    right: 12px !important;
    top: auto !important;
    bottom: calc(84px + env(safe-area-inset-bottom, 0px)) !important;
  }
  #themePanel > div{
    width: 100% !important;
  }
}

/* Reduce motion for users who prefer it */
@media (prefers-reduced-motion: reduce){
  *{transition:none !important; scroll-behavior:auto !important;}
  button:active{transform:none;}
}

/* Slightly more fluid type */
h1{font-size: clamp(1.25rem, 2.6vw, 1.65rem);}
.subhead{font-size: clamp(.9rem, 1.6vw, .98rem);}


/* =========================
   Result width + wrapping (v8)
   ========================= */
#resultMeta, .chip, .summaryTile, .miniCard, .tableWrap, table.std td, table.std th{
  overflow-wrap: anywhere;
  word-break: break-word;
}
.resultHeader .meta{max-width: 100%;}
.resultHeader{align-items:flex-start;}
/* Let summary tiles breathe a bit on wide screens */
@media (min-width: 920px){
  .summaryBar{gap: 12px;}
  .summaryTile{min-width: 260px;}
}
/* Reduce forced min widths so text doesn't "clip" on medium screens */
@media (max-width: 1000px){
  table.std{min-width: 680px;}
}


/* ===== UX Add-ons (v6) ===== */
.areaToggles{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  padding: 10px 14px 0;
}
.areaToggles .label{
  font-weight:800;
  font-size:.92rem;
  color: var(--muted);
  margin-right: 4px;
}
.toggle{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:.35rem .6rem;
  border-radius: 999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.06);
}
.toggle input{ accent-color: var(--primary2); }
.tabBtn.disabled{
  opacity:.45;
  pointer-events:none;
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
.controlsLeft{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
button.ghost{
  background: transparent;
  border: 1px dashed rgba(255,255,255,.22);
  color: var(--muted);
}
button.ghost:hover{border-color: rgba(255,255,255,.38); color: var(--text);}
.switchBox{
  margin-top: 10px;
  border-radius: var(--radius2);
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  padding: 10px 12px;
}
.switchBox .row{margin-top: 0;}
.switchBox .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 8px;}
.switchBox .actions .hint{margin:0;}

/* Ergebnis-Tabellen: Überschriften nicht umbrechen */
.results-table th,
.summary-table th {
  white-space: nowrap;
  font-size: 0.9rem;
  padding: 6px 8px;
}

@media print {
  .results-table th,
  .summary-table th {
    white-space: nowrap;
  }
}



/* Theme-Popup: weniger gestaut + nichts wird abgeschnitten */
#themePanel{
  /* auf kleinen Screens lieber mittig */
  right:18px;
}
#themePanel .themeCard{
  max-height: calc(100dvh - 240px);
  overflow: auto;
  padding-bottom: 18px;
  -webkit-overflow-scrolling: touch;
}
#themePanel .themeGrid{
  display:grid !important;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)) !important;
  gap:10px !important;
}

/* Buttons innen etwas luftiger */
.themeChoice{
  padding:12px 12px;
}
.themeChoice .desc{
  overflow: visible;
  white-space: normal;
}

/* Wenn der Bildschirm sehr schmal ist: Popup zentrieren */
@media (max-width: 520px){
  #themePanel{
    left: 12px !important;
    right: 12px !important;
    top: 70px !important;
  }
  #themePanel .themeCard{
    width: 100% !important;
  }
  #themePanel .themeGrid{
    grid-template-columns: 1fr !important;
  }
}


/* ===== Messpunkte / Modi ===== */
.modeBox{ width:100%; }
.readingsTable input[type=date],
.readingsTable input[type=number],
.readingsTable input[type=text]{ width:100%; }
.readingsTable td{ vertical-align:middle; }
.readingsTable .delBtn{ padding:6px 10px; border-radius:10px; }


/* Link as button */
a.light, a.ghost, a.success { text-decoration:none; display:inline-flex; align-items:center; justify-content:center; }
a.light:hover, a.ghost:hover, a.success:hover { text-decoration:none; }


/* Messpunkte einklappen (Variante B: Button + CSS) */
.readingsHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 8px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  margin-bottom: 10px;
}
.readingsHeader .left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 0;
}
.readingsHeader .right{
  display:flex;
  align-items:center;
  gap:10px;
}
.readingsToggle{
  white-space: nowrap;
}
.readingsMeta{
  display:inline-flex;
  align-items:center;
  gap:8px;
  color: var(--muted);
  font-weight: 900;
  white-space: nowrap;
}
.readingsCount{
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-variant-numeric: tabular-nums;
}
.readingsBody{
  transition: max-height .25s ease, opacity .2s ease;
  max-height: 1800px;
  opacity: 1;
}
.readingsBody.collapsed{
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  pointer-events: none;
}


/* Schnelleingabe (Neuer Stand/Datum/Abschlag) einklappbar */
.simpleHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 8px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  margin-bottom: 10px;
}
.simpleHeader .left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 0;
}
.simpleToggle{
  white-space: nowrap;
}
.simpleBody{
  transition: max-height .25s ease, opacity .2s ease;
  max-height: 900px;
  opacity: 1;
}
.simpleBody.collapsed{
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  pointer-events: none;
}


/* Messwert-Zeitraum rechts unter dem Hinweis */
.spanPreviewSlot{
  margin-top: 14px;
}
.spanPreviewSlot .spanPreviewTitle{
  font-weight: 900;
  margin-bottom: 8px;
}


/* Stickybar: ein/ausblendbar + dynamischer Abstand (ohne riesiges Padding) */
:root{ --stickyH: 0px; }
main{ padding-bottom: calc(var(--stickyH) + 18px) !important; }

.stickyBar{
  transition: transform .22s ease, opacity .18s ease;
}
.stickyBar.isHidden{
  transform: translateY(110%);
  pointer-events: none;
  opacity: 0;
}

.stickyShow{
  position: fixed;
  right: 14px;
  bottom: 14px;
  z-index: 9999;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  backdrop-filter: blur(10px);
  color: var(--text);
  font-weight: 950;
}

</style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#78aaff">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Nebenkosten">

</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Alexander sein Nebenkostenrechner</h1>
        <p class="subhead">News: Modern & bunt, bessere Übersicht, Tabs für Gas/Strom/Wasser, einklappbare Details. Brennwert × Zustandszahl → Gas‑Faktor.</p>
      </div>
    </div>
    <div class="chips">
      <span class="chip"><span class="dot p"></span> Tagegenau</span>
      <span class="chip"><span class="dot"></span> Tarifwechsel</span>
      <span class="chip"><span class="dot a"></span> PDF</span>
      <span class="chip"><span class="dot r"></span> Plausibilitätschecks</span>
    </div>
  </div>


    <div class="chips">
      <button class="tabBtn" id="themeBtn" type="button" aria-haspopup="dialog" aria-expanded="false" title="Design auswählen">
        <span style="display:inline-flex;align-items:center;gap:8px;">
          <span id="gearIcon" aria-hidden="true" style="display:inline-flex;width:18px;height:18px;">
            <!-- simple gear svg -->
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="currentColor" stroke-width="2"/>
              <path d="M19.4 13.5v-3l-2-.7a7.7 7.7 0 0 0-.7-1.6l1-1.9-2.1-2.1-1.9 1a7.7 7.7 0 0 0-1.6-.7l-.7-2h-3l-.7 2a7.7 7.7 0 0 0-1.6.7l-1.9-1L3.3 6.3l1 1.9a7.7 7.7 0 0 0-.7 1.6l-2 .7v3l2 .7c.16.55.4 1.08.7 1.6l-1 1.9 2.1 2.1 1.9-1c.52.3 1.05.54 1.6.7l.7 2h3l.7-2c.55-.16 1.08-.4 1.6-.7l1.9 1 2.1-2.1-1-1.9c.3-.52.54-1.05.7-1.6l2-.7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          Design
        </span>
      </button>
    </div>

    <!-- Theme picker -->
    <div id="themePanel" role="dialog" aria-modal="false" aria-label="Design auswählen" style="display:none; position:fixed; top:76px; right:18px; z-index:50;">
      <div class="themeCard" style="
        width:min(420px, calc(100vw - 24px));
        border-radius:18px;
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.08);
        backdrop-filter: blur(14px);
        box-shadow: var(--shadow);
        overflow:hidden;">
        <div style="padding:12px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <div style="font-weight:950; letter-spacing:-.01em;">Design auswählen</div>
            <div style="color:var(--muted); font-size:.9rem; margin-top:.15rem;">Wird automatisch gespeichert.</div>
          </div>
          <button class="ghost" type="button" id="themeClose" style="height:40px;padding:8px 10px;border-radius:12px;">Schließen</button>
        </div>
        <div style="height:1px;background:rgba(255,255,255,.10)"></div>

        <div style="padding:12px 12px; display:grid; gap:10px;">
          <div class="themeGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <!-- buttons injected by JS -->
          </div>
        </div>
      </div>
    </div>

  <div class="notice" id="notice" role="status" aria-live="polite"></div>

  <div class="grid">
    <!-- LEFT: Inputs -->
    <section class="card" aria-label="Eingaben">
      <div class="cardHeader">
        <div>
          <h2>Eingaben</h2>
          <p>Alles wird automatisch gespeichert. Auf dem Handy sind Gas/Strom/Wasser als Tabs.</p>
        </div>
        <div class="chips">
          <span class="chip"><span class="dot p"></span><span id="modeChip">Tagegenau</span></span>
          <span class="chip"><span class="dot"></span>v5</span>
        </div>
      </div>
      <div class="divider"></div>

      <!-- Settings -->
      <div class="cardBody settingsCompact">
        <div class="row">
          <label>Rechenmodus
            <select id="calcMode">
              <option value="daily" selected>Tagegenau (empfohlen)</option>
              <option value="monthly">Monatslogik (wie früher)</option>
            </select>
            <span class="small">Tagegenau verteilt Grundpreise & Abschläge auf Kalendertage.</span>
          </label>
        </div>

        <details class="settingsDetails">
          <summary>Gas-Berechnung (Brennwert, Zustandszahl, Faktor)</summary>
          <div class="inner">
            <div class="row">
              <label>Brennwert
            <input type="number" step="0.001" id="gasBrennwert" value="10.700">
            <span class="unit">kWh/m³</span>
            <div class="error-msg" id="err-gasBrennwert"></div>
          </label>
          <label>Zustandszahl
            <input type="number" step="0.001" id="gasZustand" value="1.000">
            <div class="error-msg" id="err-gasZustand"></div>
          </label>
          <label>Gas‑Faktor
            <input type="number" step="0.0001" id="gasFactor" value="10.70" readonly>
            <span class="small">Automatisch: Brennwert × Zustandszahl</span>
            <div class="error-msg" id="err-gasFactor"></div>
          </label>
        
            </div>
          </div>
        </details>
      </div>

      
      <div class="areaToggles" aria-label="Bereiche berücksichtigen">
        <span class="label">Berücksichtigen:</span>
        <label class="toggle"><input type="checkbox" id="inc-gas" checked> Gas</label>
        <label class="toggle"><input type="checkbox" id="inc-strom" checked> Strom</label>
        <label class="toggle"><input type="checkbox" id="inc-wasser" checked> Wasser</label>
        <span class="small" style="margin:0;">Deaktivierte Bereiche werden beim Rechnen ignoriert.</span>
      </div>
<div class="tabs" role="tablist" aria-label="Bereiche">
        <button class="tabBtn" role="tab" id="tab-gas" aria-controls="panel-gas" aria-selected="true">Gas</button>
        <button class="tabBtn" role="tab" id="tab-strom" aria-controls="panel-strom" aria-selected="false">Strom</button>
        <button class="tabBtn" role="tab" id="tab-wasser" aria-controls="panel-wasser" aria-selected="false">Wasser</button>
      </div>

      <!-- GAS -->
      <div class="cardBody tabPanel active" id="panel-gas" role="tabpanel" aria-labelledby="tab-gas">
        
        <div class="row">
          <label>Eingabe
            <select id="gasInputMode">
              <option value="simple">Start &amp; Ende</option>
              <option value="readings">Messpunkte</option>
            </select>
            <span class="small">Messpunkte sind ideal für Wochenwerte, Monats- und Saisonvergleiche.</span>
          </label>
        </div>
<div id="gasSimpleBox" class="modeBox"><div class="row">
          <label>Alter Zählerstand
            <input type="number" step="0.01" id="gasAlt" value="14898">
            <span class="unit">m³</span>
            <div class="error-msg" id="err-gasAlt"></div>
          </label>
          <label>Datum alt
            <input type="date" id="gasAltDatum" value="2025-05-27">
          </label>
        </div>

        </div>

        <div id="gasReadingsBox" class="modeBox" style="display:none">
  <div class="readingsHeader">
    <div class="left">
      <button class="ghost readingsToggle" type="button" data-toggle-readings="gas">Messpunkte anzeigen</button>
      <span class="readingsMeta">Anzahl <span class="readingsCount" id="gasReadingsCount">0</span></span>
    </div>
    <div class="right">
      <button class="light" type="button" data-add-reading="gas">+ Messpunkt</button>
    </div>
  </div>
  <div class="readingsBody collapsed" id="gasReadingsBody">
    <div class="tableWrap">
            <table class="tariffTable readingsTable" aria-label="Messpunkte">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th class="num">Stand</th>
                  <th>Notiz</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="gasReadingsTbody"></tbody>
            </table>
          </div>

          <div class="controls">
            <div class="controlsLeft">
              <button class="light" type="button" data-add-reading="gas">+ Messpunkt</button>
              <button class="ghost" type="button" data-convert-simple="gas">Start/Ende → Messpunkte</button>
              <button class="ghost" type="button" data-convert-readings="gas">Messpunkte → Start/Ende</button>
            </div>
          </div>

          <textarea id="gasReadingsJSON" style="display:none"></textarea>
          <div class="small" id="gasReadingsHint">Tipp: Wenn du jede Woche am selben Wochentag misst, werden Trends besonders gut sichtbar.</div>
  </div>
</div><div class="simpleHeader">
  <div class="left">
    <button class="ghost simpleToggle" type="button" data-toggle-simple="gas">Schnelleingabe ausblenden</button>
  </div>
</div>
<div class="simpleBody" id="gasSimpleBody">
  <div class="readingGrid">
      <label>Neuer Zählerstand
            <input type="number" step="0.01" id="gasNeu">
            <span class="unit">m³</span>
            <div class="error-msg" id="err-gasNeu"></div>
</div>
          </label>
      <label>Datum neu
            <input type="date" id="gasNeuDatum">
            <div class="error-msg" id="err-gasNeuDatum"></div>
          </label>
      <label class="full">Monatlicher Abschlag
          <input type="number" step="0.01" id="gasMonatAbschlag" placeholder="z. B. 12,50">
          <span class="unit">€/Monat</span>
          <div class="error-msg" id="err-gasMonatAbschlag"></div>
        </label>
    </div>

        <div class="tariffs">
          <h3>Tarife (Preisänderungen)</h3>
          <span class="small">Wenn du keine Preisänderungen hattest: lass 1 Zeile stehen.</span>
          <table>
            <thead>
              <tr>
                <th>Von</th><th>Bis</th>
                <th class="num">€/kWh</th>
                <th class="num">€/Monat</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="gasTariffs"></tbody>
          </table>
          
          <div class="controls">
            <div class="controlsLeft">
              <button class="light" type="button" data-add-tariff="gas">+ Tarif</button>
              <button class="ghost" type="button" data-preset="gas-typisch">Typischer Gastarif</button>
              <button class="ghost" type="button" data-tariff-switch-open="gas">Tarifwechsel…</button>
            </div>
            <span class="hint">“Bis” leer = gilt bis Enddatum.</span>
          </div>
          
            <div class="switchBox" id="switch-gas" hidden>
              <div class="row">
                <label>Tarifwechsel ab
                  <input type="date" id="gasSwitchDate">
                  <div class="error-msg" id="err-gasSwitchDate"></div>
                </label>
              </div>
              <div class="formGrid">
                <label>Neuer Arbeitspreis
                  <input type="number" step="0.0001" id="gasSwitchArbeit" placeholder="z. B. 0,3340">
                  <span class="unit">€/kWh</span>
                </label>
                <label>Neuer Grundpreis
                  <input type="number" step="0.01" id="gasSwitchGrund" placeholder="z. B. 12,00">
                  <span class="unit">€/Monat</span>
                </label>
                
              </div>
              <div class="actions">
                <button class="light" type="button" data-apply-switch="gas">Übernehmen</button>
                <button class="secondary" type="button" data-cancel-switch="gas">Abbrechen</button>
                <span class="hint">Tipp: Datum muss im Messzeitraum liegen.</span>
              </div>
            </div>
    
    
        </div>

        <div class="preview" id="gasPreview" aria-live="polite"></div>
      </div>

      <!-- STROM -->
      <div class="cardBody tabPanel" id="panel-strom" role="tabpanel" aria-labelledby="tab-strom">
        
        <div class="row">
          <label>Eingabe
            <select id="stromInputMode">
              <option value="simple">Start &amp; Ende</option>
              <option value="readings">Messpunkte</option>
            </select>
            <span class="small">Messpunkte sind ideal für Wochenwerte, Monats- und Saisonvergleiche.</span>
          </label>
        </div>
<div id="stromSimpleBox" class="modeBox"><div class="row">
          <label>Alter Zählerstand
            <input type="number" step="0.01" id="stromAlt" value="0">
            <span class="unit">kWh</span>
            <div class="error-msg" id="err-stromAlt"></div>
          </label>
          <label>Datum alt
            <input type="date" id="stromAltDatum" value="2025-06-19">
          </label>
        </div>

        </div>

        <div id="stromReadingsBox" class="modeBox" style="display:none">
  <div class="readingsHeader">
    <div class="left">
      <button class="ghost readingsToggle" type="button" data-toggle-readings="strom">Messpunkte anzeigen</button>
      <span class="readingsMeta">Anzahl <span class="readingsCount" id="stromReadingsCount">0</span></span>
    </div>
    <div class="right">
      <button class="light" type="button" data-add-reading="strom">+ Messpunkt</button>
    </div>
  </div>
  <div class="readingsBody collapsed" id="stromReadingsBody">
    <div class="tableWrap">
            <table class="tariffTable readingsTable" aria-label="Messpunkte">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th class="num">Stand</th>
                  <th>Notiz</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="stromReadingsTbody"></tbody>
            </table>
          </div>

          <div class="controls">
            <div class="controlsLeft">
              <button class="light" type="button" data-add-reading="strom">+ Messpunkt</button>
              <button class="ghost" type="button" data-convert-simple="strom">Start/Ende → Messpunkte</button>
              <button class="ghost" type="button" data-convert-readings="strom">Messpunkte → Start/Ende</button>
            </div>
          </div>

          <textarea id="stromReadingsJSON" style="display:none"></textarea>
          <div class="small" id="stromReadingsHint">Tipp: Wenn du jede Woche am selben Wochentag misst, werden Trends besonders gut sichtbar.</div>
  </div>
</div><div class="simpleHeader">
  <div class="left">
    <button class="ghost simpleToggle" type="button" data-toggle-simple="strom">Schnelleingabe ausblenden</button>
  </div>
</div>
<div class="simpleBody" id="stromSimpleBody">
  <div class="readingGrid">
      <label>Neuer Zählerstand
            <input type="number" step="0.01" id="stromNeu">
            <span class="unit">kWh</span>
            <div class="error-msg" id="err-stromNeu"></div>
</div>
          </label>
      <label>Datum neu
            <input type="date" id="stromNeuDatum">
            <div class="error-msg" id="err-stromNeuDatum"></div>
          </label>
      <label class="full">Monatlicher Abschlag
          <input type="number" step="0.01" id="stromMonatAbschlag" placeholder="z. B. 15,00">
          <span class="unit">€/Monat</span>
          <div class="error-msg" id="err-stromMonatAbschlag"></div>
        </label>
    </div>

        <div class="tariffs">
          <h3>Tarife (Preisänderungen)</h3>
          <table>
            <thead>
              <tr>
                <th>Von</th><th>Bis</th>
                <th class="num">€/kWh</th>
                <th class="num">€/Monat</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="stromTariffs"></tbody>
          </table>
          
          <div class="controls">
            <div class="controlsLeft">
              <button class="light" type="button" data-add-tariff="strom">+ Tarif</button>
              <button class="ghost" type="button" data-preset="strom-typisch">Typischer Stromtarif</button>
              <button class="ghost" type="button" data-tariff-switch-open="strom">Tarifwechsel…</button>
            </div>
            <span class="hint">“Bis” leer = gilt bis Enddatum.</span>
          </div>
          
            <div class="switchBox" id="switch-strom" hidden>
              <div class="row">
                <label>Tarifwechsel ab
                  <input type="date" id="stromSwitchDate">
                  <div class="error-msg" id="err-stromSwitchDate"></div>
                </label>
              </div>
              <div class="formGrid">
                <label>Neuer Arbeitspreis
                  <input type="number" step="0.0001" id="stromSwitchArbeit" placeholder="z. B. 0,3340">
                  <span class="unit">€/kWh</span>
                </label>
                <label>Neuer Grundpreis
                  <input type="number" step="0.01" id="stromSwitchGrund" placeholder="z. B. 12,00">
                  <span class="unit">€/Monat</span>
                </label>
                
              </div>
              <div class="actions">
                <button class="light" type="button" data-apply-switch="strom">Übernehmen</button>
                <button class="secondary" type="button" data-cancel-switch="strom">Abbrechen</button>
                <span class="hint">Tipp: Datum muss im Messzeitraum liegen.</span>
              </div>
            </div>
    
    
        </div>

        <div class="preview" id="stromPreview" aria-live="polite"></div>
      </div>

      <!-- WASSER -->
      <div class="cardBody tabPanel" id="panel-wasser" role="tabpanel" aria-labelledby="tab-wasser">
        
        <div class="row">
          <label>Eingabe
            <select id="wasserInputMode">
              <option value="simple">Start &amp; Ende</option>
              <option value="readings">Messpunkte</option>
            </select>
            <span class="small">Messpunkte sind ideal für Wochenwerte, Monats- und Saisonvergleiche.</span>
          </label>
        </div>
<div id="wasserSimpleBox" class="modeBox"><div class="row">
          <label>Alter Zählerstand
            <input type="number" step="0.01" id="wasserAlt" value="108">
            <span class="unit">m³</span>
            <div class="error-msg" id="err-wasserAlt"></div>
          </label>
          <label>Datum alt
            <input type="date" id="wasserAltDatum" value="2025-05-27">
          </label>
        </div>

        </div>

        <div id="wasserReadingsBox" class="modeBox" style="display:none">
  <div class="readingsHeader">
    <div class="left">
      <button class="ghost readingsToggle" type="button" data-toggle-readings="wasser">Messpunkte anzeigen</button>
      <span class="readingsMeta">Anzahl <span class="readingsCount" id="wasserReadingsCount">0</span></span>
    </div>
    <div class="right">
      <button class="light" type="button" data-add-reading="wasser">+ Messpunkt</button>
    </div>
  </div>
  <div class="readingsBody collapsed" id="wasserReadingsBody">
    <div class="tableWrap">
            <table class="tariffTable readingsTable" aria-label="Messpunkte">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th class="num">Stand</th>
                  <th>Notiz</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="wasserReadingsTbody"></tbody>
            </table>
          </div>

          <div class="controls">
            <div class="controlsLeft">
              <button class="light" type="button" data-add-reading="wasser">+ Messpunkt</button>
              <button class="ghost" type="button" data-convert-simple="wasser">Start/Ende → Messpunkte</button>
              <button class="ghost" type="button" data-convert-readings="wasser">Messpunkte → Start/Ende</button>
            </div>
          </div>

          <textarea id="wasserReadingsJSON" style="display:none"></textarea>
          <div class="small" id="wasserReadingsHint">Tipp: Wenn du jede Woche am selben Wochentag misst, werden Trends besonders gut sichtbar.</div>
  </div>
</div><div class="simpleHeader">
  <div class="left">
    <button class="ghost simpleToggle" type="button" data-toggle-simple="wasser">Schnelleingabe ausblenden</button>
  </div>
</div>
<div class="simpleBody" id="wasserSimpleBody">
  <div class="readingGrid">
      <label>Neuer Zählerstand
            <input type="number" step="0.01" id="wasserNeu">
            <span class="unit">m³</span>
            <div class="error-msg" id="err-wasserNeu"></div>
</div>
          </label>
      <label>Datum neu
            <input type="date" id="wasserNeuDatum">
            <div class="error-msg" id="err-wasserNeuDatum"></div>
          </label>
      <label class="full">Monatlicher Abschlag
          <input type="number" step="0.01" id="wasserMonatAbschlag" placeholder="z. B. 5,00">
          <span class="unit">€/Monat</span>
          <div class="error-msg" id="err-wasserMonatAbschlag"></div>
        </label>
    </div>

        <div class="tariffs">
          <h3>Tarife (Preisänderungen)</h3>
          <span class="small">Wasser: Grundpreis + Service sind pro Jahr und werden tagesanteilig gerechnet.</span>
          <table>
            <thead>
              <tr>
                <th>Von</th><th>Bis</th>
                <th class="num">€/m³</th>
                <th class="num">€/Jahr</th>
                <th class="num">Service/Jahr</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="wasserTariffs"></tbody>
          </table>
          
          <div class="controls">
            <div class="controlsLeft">
              <button class="light" type="button" data-add-tariff="wasser">+ Tarif</button>
              <button class="ghost" type="button" data-preset="wasser-mit-service">Wasser mit Service</button>
              <button class="ghost" type="button" data-tariff-switch-open="wasser">Tarifwechsel…</button>
            </div>
            <span class="hint">“Bis” leer = gilt bis Enddatum.</span>
          </div>
          
            <div class="switchBox" id="switch-wasser" hidden>
              <div class="row">
                <label>Tarifwechsel ab
                  <input type="date" id="wasserSwitchDate">
                  <div class="error-msg" id="err-wasserSwitchDate"></div>
                </label>
              </div>
              <div class="formGrid">
                <label>Neuer Arbeitspreis
                  <input type="number" step="0.0001" id="wasserSwitchArbeit" placeholder="z. B. 0,3340">
                  <span class="unit">€/m³</span>
                </label>
                <label>Neuer Grundpreis
                  <input type="number" step="0.01" id="wasserSwitchGrund" placeholder="z. B. 12,00">
                  <span class="unit">€/Jahr</span>
                </label>
                <label>Neuer Service<br><input type="number" step="0.01" id="wasserSwitchService" placeholder="z. B. 34,04"><span class="unit">€/Jahr</span></label>
              </div>
              <div class="actions">
                <button class="light" type="button" data-apply-switch="wasser">Übernehmen</button>
                <button class="secondary" type="button" data-cancel-switch="wasser">Abbrechen</button>
                <span class="hint">Tipp: Datum muss im Messzeitraum liegen.</span>
              </div>
            </div>
    
    
        </div>

        <div class="preview" id="wasserPreview" aria-live="polite"></div>
      </div>
    </section>

    <!-- RIGHT: Results -->
    <section class="card" aria-label="Ergebnis">
      <div class="resultHeader">
        <div>
          <h2>Ergebnis</h2>
          <div class="meta" id="resultMeta">Noch nichts berechnet.</div>
        </div>
        <div class="chips">
          <span class="chip"><span class="dot p"></span><span id="factorChip">Gas‑Faktor: 10.7000</span></span>
        </div>
      </div>
      <div class="divider"></div>

      <div class="result" id="resultInner">
        <div class="summaryBar" id="summaryBar"></div>
        <div class="hint" style="padding:0 14px 8px; font-weight:900; color:var(--muted);">Einzelergebnisse</div>
        <div class="cards" id="resultCards"></div>

        <details id="detailsTotals">
          <summary>Gesamtübersicht</summary>
          <div class="inner">
            <div class="tableWrap" id="totalsTableWrap"></div>
          </div>
        </details>

        <details id="detailsTariffs">
          <summary>Details: Tarifabschnitte</summary>
          <div class="inner" id="tariffDetails"></div>
        </details>

        <div class="hint" style="padding:0 14px 14px;">
          Hinweis: Verbrauch wird gleichmäßig über den Zeitraum verteilt (weil nur Start/End‑Zählerstände vorhanden sind).
<div id="spanPreviewSlot" class="spanPreviewSlot"></div>
        </div>
      </div>

      <div class="cardBody" id="emptyState">
        <div class="preview">
          <div class="kpis">
            <span class="kpi"><strong>Tipp:</strong> Füll die neuen Zählerstände ein</span>
            <span class="kpi">Dann auf <strong>Berechnen</strong></span>
          </div>
          <div style="margin-top:.6rem;color:var(--muted);line-height:1.4;">
            Du kannst Preisänderungen als Tarifzeilen eintragen. Wenn es keine gab: 1 Zeile reicht.
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="stickyBar">
  <div class="stickyInner">
    <div class="btns">
      <button id="calcBtn">Berechnen</button>
      <button id="pdfBtn" class="success" style="display:none;">PDF</button>
      <a id="analysisLink" class="light" href="Analyse_Messpunkte.html" target="_blank" rel="noopener">Analyse & Diagramme</a>
      <button id="resetBtn" class="secondary">Reset</button>
      <button id="exportBtn" class="light" type="button">Export</button>
      <select id="exportScope" class="ghost" style="height:44px; padding:0 12px; border-radius:14px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:var(--text); font-weight:900;">
        <option value="all" selected>Gesamt</option>
        <option value="gas">Nur Gas</option>
        <option value="strom">Nur Strom</option>
        <option value="wasser">Nur Wasser</option>
      </select>
      <button id="importBtn" class="ghost" type="button">Import</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="stickyToggle" class="ghost" type="button" title="Leiste ein/ausblenden">Leiste ausblenden</button>
    </div>
    <div class="rightHint">
      <span class="spark" aria-hidden="true"></span>
      <span class="hint">Modern & bunt • kein Popup‑Stress</span>
    </div>
  </div>
</div>

<button id="stickyShow" class="stickyShow" type="button" style="display:none;">Leiste anzeigen</button>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
function moveSpanPreview(){
  const slot = document.getElementById('spanPreviewSlot');
  if(!slot) return;

  const preview = document.querySelector('.preview');
  if(!preview) return;

  if(!slot.querySelector('.spanPreviewTitle')){
    const h = document.createElement('div');
    h.className = 'spanPreviewTitle';
    h.textContent = 'Messwert-Zeitraum';
    slot.appendChild(h);
  }

  slot.appendChild(preview);
}

</script>
<script>
/* ==================== Storage ==================== */
const STORAGE_KEY = "nebenkosten_v5_modern";

/* ==================== Dates & Time ==================== */
function parseDate(value){
  if (!value) return null;
  const d = new Date(value + "T00:00:00");
  return Number.isNaN(d.getTime()) ? null : d;
}
function fmtISO(d){
  const z = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  return z.toISOString().slice(0,10);
}
function daysBetween(start, end){
  const s = parseDate(start), e = parseDate(end);
  if (!s || !e) return 0;
  const ms = e - s;
  if (ms <= 0) return 0;
  return Math.round(ms / (24*3600*1000));
}
function isLeapYear(y){ return (y%4===0 && y%100!==0) || (y%400===0); }
function daysInYear(y){ return isLeapYear(y) ? 366 : 365; }
function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); }
function addDays(d, n){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  x.setDate(x.getDate() + n);
  return x;
}
function monthDiff(start, end) {
  const s = parseDate(start);
  const e = parseDate(end);
  if (!s || !e) return 0;
  if (e < s) return 0;
  let months = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth());
  if (e.getDate() < s.getDate()) months--;
  return Math.max(months, 1);
}

/* ==================== Validation ==================== */
function setInvalid(el, msg) {
  if (!el) return;
  el.classList.add('invalid');
  const err = document.getElementById('err-' + el.id);
  if (err) err.textContent = msg || 'Bitte prüfen';
}
function clearInvalid(el) {
  if (!el) return;
  el.classList.remove('invalid');
  const err = document.getElementById('err-' + el.id);
  if (err) err.textContent = '';
}
function validateNonNegative(el) {
  const v = el.value.trim();
  if (v === '') { clearInvalid(el); return true; }
  const n = Number(v);
  if (Number.isNaN(n)) { setInvalid(el, 'Bitte eine gültige Zahl eingeben'); return false; }
  if (n < 0) { setInvalid(el, 'Darf nicht negativ sein'); return false; }
  clearInvalid(el); return true;
}
function validatePositive(el){
  const v = el.value.trim();
  if (v === '') { setInvalid(el, 'Pflichtfeld'); return false; }
  const n = Number(v);
  if (Number.isNaN(n)) { setInvalid(el, 'Bitte eine gültige Zahl eingeben'); return false; }
  if (n <= 0) { setInvalid(el, 'Muss > 0 sein'); return false; }
  clearInvalid(el); return true;
}
function validateDatePair(prefix){
  const a = document.getElementById(prefix + 'AltDatum');
  const n = document.getElementById(prefix + 'NeuDatum');
  const errEl = document.getElementById('err-' + n.id);
  if (!a.value || !n.value) { n.classList.remove('invalid'); if (errEl) errEl.textContent=''; return true; }
  const s = parseDate(a.value), e = parseDate(n.value);
  if (!s || !e) return true;
  if (e <= s){
    n.classList.add('invalid');
    if (errEl) errEl.textContent = 'Neues Datum muss nach dem alten Datum liegen';
    return false;
  }
  n.classList.remove('invalid');
  if (errEl) errEl.textContent = '';
  return true;
}
function validateMeterPair(prefix){
  const a = document.getElementById(prefix + 'Alt');
  const n = document.getElementById(prefix + 'Neu');
  const av = a.value.trim(), nv = n.value.trim();
  if (av === '' || nv === '') { clearInvalid(n); return true; }
  const an = Number(av), nn = Number(nv);
  if (Number.isNaN(an) || Number.isNaN(nn)) return true;
  if (nn < an){ setInvalid(n, 'Neuer Stand muss ≥ alter Stand sein'); return false; }
  clearInvalid(n);
  return true;
}
function validateTariffs(prefix){
  const tbody = document.getElementById(prefix+'Tariffs');
  if (!tbody) return true;
  let ok = true;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelectorAll('input[type=number]').forEach(inp=>{
      if (!validateNonNegative(inp)) ok = false;
    });
    const from = tr.querySelector('input[data-role="from"]');
    const to = tr.querySelector('input[data-role="to"]');
    if (from && to && from.value && to.value){
      const s = parseDate(from.value), e = parseDate(to.value);
      if (s && e && e < s){
        setInvalid(to, 'Bis muss ≥ Von sein');
        ok = false;
      } else {
        clearInvalid(to);
      }
    }
  });
  return ok;
}

/* ==================== Notice (no alerts) ==================== */
function hideNotice(){
  const n = document.getElementById('notice');
  n.style.display = 'none';
  n.innerHTML = '';
}
function showNotice(messages){
  const n = document.getElementById('notice');
  if (!messages || !messages.length){ hideNotice(); return; }
  n.style.display = 'block';
  n.innerHTML = `
    <strong>Bitte kurz prüfen</strong>
    <div class="hint">Ich kann erst rechnen, wenn die rot markierten Felder passen.</div>
    <ul>${messages.map(m=>`<li>${m}</li>`).join('')}</ul>
  `;
  n.scrollIntoView({behavior:'smooth', block:'start'});
}
function collectIssues(){
  const issues = [];
  const invalids = Array.from(document.querySelectorAll('.invalid'));
  invalids.slice(0,8).forEach(el=>{
    const label = el.closest('label');
    const name = label ? (label.childNodes[0]?.textContent || '').trim() : (el.id || 'Feld');
    issues.push(`${name || 'Feld'} ist nicht plausibel`);
  });
  if (invalids.length > 8) issues.push(`+ ${invalids.length - 8} weitere Felder`);
  return issues;
}

/* ==================== Tariff UI ==================== */
function tariffRowHTML(prefix, values){
  const isWater = (prefix === 'wasser');
  const from = values?.from || '';
  const to = values?.to || '';
  const arbeit = values?.arbeit ?? (prefix==='gas' ? 0.1070 : prefix==='strom' ? 0.3340 : 1.99);
  const grund  = values?.grund  ?? (prefix==='gas' ? 14.00 : prefix==='strom' ? 12.00 : 112.50);
  const service= values?.service?? 34.04;

  if (!isWater){
    return `
      <tr>
        <td><input type="date" data-role="from" value="${from}"></td>
        <td><input type="date" data-role="to" value="${to}"></td>
        <td class="num"><input type="number" step="0.0001" data-role="arbeit" value="${arbeit}"></td>
        <td class="num"><input type="number" step="0.01" data-role="grund" value="${grund}"></td>
        <td><button type="button" class="light" data-remove-tariff="${prefix}">×</button></td>
      </tr>`;
  }
  return `
    <tr>
      <td><input type="date" data-role="from" value="${from}"></td>
      <td><input type="date" data-role="to" value="${to}"></td>
      <td class="num"><input type="number" step="0.0001" data-role="arbeit" value="${arbeit}"></td>
      <td class="num"><input type="number" step="0.01" data-role="grund" value="${grund}"></td>
      <td class="num"><input type="number" step="0.01" data-role="service" value="${service}"></td>
      <td><button type="button" class="light" data-remove-tariff="${prefix}">×</button></td>
    </tr>`;
}
function ensureAtLeastOneTariff(prefix){
  const tbody = document.getElementById(prefix+'Tariffs');
  if (tbody.querySelectorAll('tr').length === 0){
    tbody.insertAdjacentHTML('beforeend', tariffRowHTML(prefix, {}));
  }
}
function addTariff(prefix, values){
  const tbody = document.getElementById(prefix+'Tariffs');
  tbody.insertAdjacentHTML('beforeend', tariffRowHTML(prefix, values));
  saveState();
}
function removeTariff(prefix, btn){
  const tr = btn.closest('tr');
  if (tr) tr.remove();
  ensureAtLeastOneTariff(prefix);
  saveState();
}
function readTariffs(prefix){
  const tbody = document.getElementById(prefix+'Tariffs');
  const tariffs = [];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const get = (role) => tr.querySelector(`input[data-role="${role}"]`);
    const from = get('from')?.value || '';
    const to = get('to')?.value || '';
    const arbeit = parseFloat(get('arbeit')?.value) || 0;
    const grund = parseFloat(get('grund')?.value) || 0;
    const service = prefix==='wasser' ? (parseFloat(get('service')?.value) || 0) : 0;
    tariffs.push({from, to, arbeit, grund, service});
  });
  return tariffs;
}
function normalizeTariffs(prefix, meterStartISO, meterEndISO){
  const start = parseDate(meterStartISO);
  const end = parseDate(meterEndISO);
  const raw = readTariffs(prefix);

  const mapped = raw.map(t=>{
    const f = t.from ? parseDate(t.from) : start;
    const to = t.to ? parseDate(t.to) : end;
    return {
      from: f, to: to,
      arbeit: Math.max(0, Number(t.arbeit)||0),
      grund: Math.max(0, Number(t.grund)||0),
      service: Math.max(0, Number(t.service)||0)
    };
  }).filter(t=>t.from && t.to);

  mapped.sort((a,b)=>a.from - b.from);

  const segs = [];
  mapped.forEach(t=>{
    const segFrom = t.from < start ? start : t.from;
    const segTo = t.to > end ? end : t.to;
    if (segTo <= segFrom) return;
    segs.push({...t, from: segFrom, to: segTo});
  });

  if (segs.length === 0){
    segs.push({from:start,to:end,arbeit:0,grund:0,service:0});
  }
  return segs;
}

/* ==================== Settings (Brennwert × Zustandszahl) ==================== */
function updateGasFactor(){
  const bw = document.getElementById('gasBrennwert');
  const zs = document.getElementById('gasZustand');
  const gf = document.getElementById('gasFactor');

  const ok1 = validatePositive(bw);
  const ok2 = validatePositive(zs);

  if (!ok1 || !ok2){
    gf.value = '';
    setInvalid(gf, 'Bitte Brennwert/Zustandszahl prüfen');
    document.getElementById('factorChip').textContent = 'Gas‑Faktor: –';
    return;
  }
  clearInvalid(gf);

  const factor = (Number(bw.value) * Number(zs.value));
  gf.value = factor.toFixed(4);
  document.getElementById('factorChip').textContent = `Gas‑Faktor: ${gf.value}`;
}
function gasFactor(){
  const v = Number(document.getElementById('gasFactor').value);
  return Number.isFinite(v) ? v : 0;
}
function mode(){ return document.getElementById('calcMode').value; }

/* ==================== Read Sections ==================== */
function parseNum(v){
  const n = Number(String(v ?? '').replace(',', '.'));
  return Number.isFinite(n) ? n : 0;
}

function getInputMode(prefix){
  const el = document.getElementById(prefix+'InputMode');
  return el ? el.value : 'simple';
}

function readSimpleSection(prefix){
  return {
    alt: parseNum(document.getElementById(prefix+'Alt').value),
    neu: parseNum(document.getElementById(prefix+'Neu').value),
    datumAlt: document.getElementById(prefix+'AltDatum').value,
    datumNeu: document.getElementById(prefix+'NeuDatum').value,
    abschlag: parseNum(document.getElementById(prefix+'MonatAbschlag').value)
  };
}

function readReadingsFromUI(prefix){
  const tbody = document.getElementById(prefix+'ReadingsTbody');
  if (!tbody) return [];
  const rows = Array.from(tbody.querySelectorAll('tr'));
  return rows.map(tr=>{
    const date = tr.querySelector('input[type=date]')?.value || '';
    const val = tr.querySelector('input[type=number]')?.value;
    const note = tr.querySelector('input[type=text]')?.value || '';
    return { date, value: parseNum(val), note };
  }).filter(r=>r.date);
}

function writeReadingsJSON(prefix, readings){
  const ta = document.getElementById(prefix+'ReadingsJSON');
  if (ta) ta.value = JSON.stringify(readings || []);
}

function readReadingsJSON(prefix){
  const ta = document.getElementById(prefix+'ReadingsJSON');
  if (!ta || !ta.value) return [];
  try{
    const arr = JSON.parse(ta.value);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}

function syncReadings(prefix){
  const readings = readReadingsFromUI(prefix);
  writeReadingsJSON(prefix, readings);
  saveState();
  ['gas','strom','wasser'].forEach(renderPreview);
}

function readSection(prefix){
  // Compatibility wrapper: used by other code paths
  return readSimpleSection(prefix);
}


/* ==================== Cost math ==================== */
function dayLoopCost(startDate, endDate, fnPerDay){
  let cost = 0;
  for (let d = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
       d < endDate;
       d = addDays(d, 1)){
    cost += fnPerDay(d);
  }
  return cost;
}
function basePerDayMonthly(amount, d){ return amount / daysInMonth(d.getFullYear(), d.getMonth()); }
function basePerDayYearly(amount, d){ return amount / daysInYear(d.getFullYear()); }
function abschlagPerDay(monthly, d){ return monthly / daysInMonth(d.getFullYear(), d.getMonth()); }
function allocateConsumption(totalConsumption, totalDays, segDays){
  if (totalDays <= 0) return 0;
  return totalConsumption * (segDays / totalDays);
}

/* ==================== Resource calc ==================== */
function dateDays(a,b){
  return Math.max(0, (b - a) / (24*3600*1000));
}

function toReadingSegments(readings, rolloverMax=null){
  const r = (readings||[])
    .filter(x=>x.date && x.value!=null)
    .map(x=>({ date:x.date, value:Number(x.value), note:x.note||'' }))
    .sort((a,b)=> a.date.localeCompare(b.date));

  const segs = [];
  for(let i=0;i<r.length-1;i++){
    const a = parseDate(r[i].date), b = parseDate(r[i+1].date);
    if(!a || !b || b<=a) continue;
    const days = dateDays(a,b);
    let delta = r[i+1].value - r[i].value;
    if(delta < 0 && rolloverMax){
      delta = (rolloverMax - r[i].value) + r[i+1].value;
    }
    if(delta < 0) continue;
    segs.push({
      from: a, to: b, fromISO: r[i].date, toISO: r[i+1].date,
      days, deltaRaw: delta, dailyRaw: delta / days
    });
  }
  return segs;
}

function overlapConsumption(segFrom, segTo, readingSegs, dailyConvGetter){
  let total = 0;
  readingSegs.forEach(rs=>{
    const s = new Date(Math.max(rs.from.getTime(), segFrom.getTime()));
    const e = new Date(Math.min(rs.to.getTime(), segTo.getTime()));
    if(e<=s) return;
    const days = dateDays(s,e);
    total += dailyConvGetter(rs) * days;
  });
  return total;
}

function validateReadings(prefix){
  const mode = getInputMode(prefix);
  if(mode !== 'readings') return true;

  const readings = readReadingsJSON(prefix);
  if(readings.length < 2){
    showNotice('Für Messpunkte brauchst du mindestens zwei Einträge (Start und Ende).', true);
    return false;
  }
  const r = [...readings].sort((a,b)=> a.date.localeCompare(b.date));
  for(let i=0;i<r.length;i++){
    if(!r[i].date){
      showNotice('Ein Messpunkt hat kein Datum.', true);
      return false;
    }
    if(!Number.isFinite(Number(r[i].value))){
      showNotice('Ein Messpunkt hat keinen gültigen Stand.', true);
      return false;
    }
    if(i>0){
      const d0 = parseDate(r[i-1].date), d1 = parseDate(r[i].date);
      if(!d0 || !d1 || d1<=d0){
        showNotice('Messpunkte müssen in aufsteigender Reihenfolge ohne doppelte Daten sein.', true);
        return false;
      }
      if(Number(r[i].value) < Number(r[i-1].value)){
        showNotice('Ein Stand ist kleiner als der vorherige. (Zählerüberlauf/Zählerwechsel ist aktuell nicht abgebildet.)', true);
        return false;
      }
    }
  }
  return true;
}

function calcResource(prefix){
  const mode = getInputMode(prefix);
  const unit = (prefix==='wasser') ? 'm³' : 'kWh';

  let startISO, endISO, abschlag;
  let readingSegs = [];

  if(mode === 'readings'){
    const readings = readReadingsJSON(prefix);
    if(!readings || readings.length < 2) return { invalid:true };
    const sorted = [...readings].sort((a,b)=> a.date.localeCompare(b.date));
    startISO = sorted[0].date;
    endISO = sorted[sorted.length-1].date;
    abschlag = parseNum(document.getElementById(prefix+'MonatAbschlag').value);

    readingSegs = toReadingSegments(sorted, null);
    if(!readingSegs.length) return { invalid:true };
  } else {
    const r = readSimpleSection(prefix);
    startISO = r.datumAlt; endISO = r.datumNeu; abschlag = r.abschlag;
    const s = parseDate(startISO), e = parseDate(endISO);
    if(!s || !e || e<=s) return { invalid:true };
    const deltaRaw = r.neu - r.alt;
    const days = dateDays(s,e);
    if(days<=0 || deltaRaw < 0) return { invalid:true };
    readingSegs = [{
      from:s, to:e, fromISO:startISO, toISO:endISO,
      days, deltaRaw, dailyRaw: deltaRaw/days
    }];
  }

  const s = parseDate(startISO), e = parseDate(endISO);
  const totalDays = daysBetween(startISO, endISO);
  const totalMonths = monthDiff(startISO, endISO);

  const conv = (prefix==='gas') ? gasFactor() : 1;
  const dailyConvGetter = (rs)=> rs.dailyRaw * conv;

  const segs = normalizeTariffs(prefix, startISO, endISO);
  let workCost = 0;
  let baseCost = 0;

  segs.forEach(seg=>{
    const cons = overlapConsumption(seg.from, seg.to, readingSegs, dailyConvGetter);
    workCost += cons * seg.arbeit;

    if (prefix === 'wasser'){
      baseCost += dayLoopCost(seg.from, seg.to, (d)=> basePerDayYearly(seg.grund, d) + basePerDayYearly(seg.service, d));
    } else {
      baseCost += dayLoopCost(seg.from, seg.to, (d)=> basePerDayMonthly(seg.grund, d));
    }
  });

  const totalCons = overlapConsumption(s, e, readingSegs, dailyConvGetter);

  const abschlagGes = dayLoopCost(s, e, (d)=> abschlagPerDay(abschlag, d));
  const kosten = workCost + baseCost;
  const delta = kosten - abschlagGes;

  return {
    invalid:false, prefix, totalCons, unit, totalDays, workCost, baseCost, kosten, abschlagGes, delta,
    inputMode: mode,
    segsSummary: segs.map(seg=>({
      from: fmtISO(seg.from), to: fmtISO(seg.to),
      arbeit: seg.arbeit, grund: seg.grund, service: seg.service,
      days: Math.round((seg.to - seg.from)/(24*3600*1000))
    })),
    readingsSummary: readingSegs.map(rs=>({
      from: rs.fromISO, to: rs.toISO,
      days: Math.round(rs.days),
      deltaRaw: rs.deltaRaw,
      delta: rs.deltaRaw * conv,
      daily: rs.dailyRaw * conv
    }))
  };
}


/* ==================== UI ==================== */
function formatEUR(n){ return (Number(n)||0).toFixed(2); }
function badge(delta){
  if (delta > 0) return `<span class="badge red">Nachzahlung: ${formatEUR(delta)} €</span>`;
  if (delta < 0) return `<span class="badge green">Rückerstattung: ${formatEUR(Math.abs(delta))} €</span>`;
  return `<span class="badge gray">Ausgeglichen</span>`;
}

function isIncluded(prefix){
  const cb = document.getElementById('inc-'+prefix);
  return cb ? cb.checked : true;
}
function setSectionEnabled(prefix, enabled){
  const btn = document.getElementById('tab-'+prefix);
  const panel = document.getElementById('panel-'+prefix);
  if (btn){
    btn.disabled = !enabled;
    btn.classList.toggle('disabled', !enabled);
    btn.setAttribute('aria-disabled', (!enabled).toString());
  }
  if (panel){
    panel.querySelectorAll('input, select, button').forEach(el=>{
      if (el.id === 'calcMode') return;
      el.disabled = !enabled;
    });
  }
}
function applyIncludeUI(){
  ['gas','strom','wasser'].forEach(p=>setSectionEnabled(p, isIncluded(p)));
  if (!isIncluded(currentTab)){
    const next = ['gas','strom','wasser'].find(isIncluded) || 'gas';
    currentTab = next;
    setActiveTab(next);
  }
}

function sectionName(p){ return p==='gas'?'Gas':p==='strom'?'Strom':'Wasser'; }

function renderPreview(prefix){
  if (!isIncluded(prefix)){
    const box = document.getElementById(prefix+'Preview');
    if (box) box.innerHTML = '';
    return;
  }
  const box = document.getElementById(prefix+'Preview');
  if (!box) return;
  const r = readSection(prefix);

  const ok =
    validateNonNegative(document.getElementById(prefix+'Alt')) &&
    validateNonNegative(document.getElementById(prefix+'Neu')) &&
    validateNonNegative(document.getElementById(prefix+'MonatAbschlag')) &&
    validateDatePair(prefix) &&
    validateMeterPair(prefix) &&
    validateTariffs(prefix);

  updateGasFactor();

  if (!r.datumAlt || !r.datumNeu || !ok || document.getElementById(prefix+'Neu').value.trim()===''){
    box.innerHTML = '';
    return;
  }

  const res = calcResource(prefix);
  if (res.invalid){ box.innerHTML=''; return; }

  const spanChip = mode()==='daily' ? `${res.totalDays} Tage` : `${res.totalMonths} Monate`;

  box.innerHTML = `
    <div class="kpis">
      <span class="kpi"><strong>${res.totalCons.toFixed(2)}</strong> ${res.unit}</span>
      <span class="kpi">${spanChip}</span>
      <span class="kpi">Kosten <strong>${formatEUR(res.kosten)} €</strong></span>
    </div>
    <div style="margin-top:.55rem; color:var(--muted); line-height:1.55;">
      Arbeit: <strong style="color:var(--text)">${formatEUR(res.workCost)} €</strong><br>
      Grund/Service: <strong style="color:var(--text)">${formatEUR(res.baseCost)} €</strong><br>
      Abschläge: <strong style="color:var(--text)">${formatEUR(res.abschlagGes)} €</strong><br>
      <div style="margin-top:.35rem">${badge(res.delta)}</div>
    </div>
  `;
}

function buildTariffSummary(res){
  const isWater = (res.prefix==='wasser');
  const head = isWater ? `
    <tr><th>Von</th><th>Bis</th><th class="num">Tage</th><th class="num">Arbeit</th><th class="num">Grund/Jahr</th><th class="num">Service/Jahr</th></tr>`
  : `<tr><th>Von</th><th>Bis</th><th class="num">Tage</th><th class="num">Arbeit</th><th class="num">Grund/Monat</th></tr>`;

  const body = res.segsSummary.map(s=>{
    if (isWater){
      return `<tr>
        <td>${s.from}</td><td>${s.to}</td><td class="num">${s.days}</td>
        <td class="num">${s.arbeit.toFixed(4)}</td>
        <td class="num">${s.grund.toFixed(2)}</td>
        <td class="num">${s.service.toFixed(2)}</td>
      </tr>`;
    }
    return `<tr>
      <td>${s.from}</td><td>${s.to}</td><td class="num">${s.days}</td>
      <td class="num">${s.arbeit.toFixed(4)}</td>
      <td class="num">${s.grund.toFixed(2)}</td>
    </tr>`;
  }).join('');

  return `
    <div style="margin-top:10px;">
      <div class="hint" style="margin-bottom:8px;"><strong style="color:var(--text)">${sectionName(res.prefix)}:</strong> Tarifabschnitte</div>
      <table class="std">
        <thead>${head}</thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;
}

function validateAll(){
  hideNotice();
  updateGasFactor();

  const allNums = Array.from(document.querySelectorAll('input[type=number]:not(:disabled)'));
  const okNums = allNums.every(validateNonNegative);

  const okGasSettings = !isIncluded('gas') || (
                        validatePositive(document.getElementById('gasBrennwert')) &&
                        validatePositive(document.getElementById('gasZustand')) &&
                        validatePositive(document.getElementById('gasFactor'))
                      );

  const okPairs = ['gas','strom','wasser'].filter(isIncluded).every(p => validateDatePair(p) && validateMeterPair(p));
  const okTar = ['gas','strom','wasser'].filter(isIncluded).every(validateTariffs);

  const ok = okNums && okPairs && okTar && okGasSettings;

  if (!ok){
    showNotice(collectIssues());
  }
  return ok;
}

function setResultVisible(visible){
  document.getElementById('resultInner').style.display = visible ? 'block' : 'none';
  document.getElementById('emptyState').style.display = visible ? 'none' : 'block';
}

function calculate(){
  if (!validateAll()) return;

  const prefixes = ['gas','strom','wasser'].filter(isIncluded);
  if (!prefixes.length){
    showNotice(['Bitte mindestens einen Bereich auswählen.']);
    return;
  }
  const resources = prefixes.map(p=>calcResource(p));
  if (resources.some(r=>r.invalid)){
    showNotice(['Bitte Datum(e) prüfen: neues Datum muss nach dem alten Datum liegen.']);
    return;
  }
  hideNotice();

  // resources already built
  const totals = {
    work: resources.reduce((a,r)=>a+r.workCost,0),
    base: resources.reduce((a,r)=>a+r.baseCost,0),
    kosten: resources.reduce((a,r)=>a+r.kosten,0),
    abschlag: resources.reduce((a,r)=>a+r.abschlagGes,0),
  };
  totals.delta = totals.kosten - totals.abschlag;

  // meta
  const m = mode()==='daily' ? 'Tagegenau' : 'Monatslogik';
  document.getElementById('modeChip').textContent = m;
  document.getElementById('resultMeta').innerHTML = `
    <span class="chip"><span class="dot p"></span> Modus: <strong style="color:var(--text)">${m}</strong></span>
    <span class="chip"><span class="dot"></span> Gas‑Faktor: <strong style="color:var(--text)">${gasFactor().toFixed(4)}</strong></span>
  `;

  // summary
  const label = totals.delta>0 ? 'Nachzahlung' : totals.delta<0 ? 'Rückerstattung' : 'Ausgeglichen';
  const deltaAbs = Math.abs(totals.delta);

  document.getElementById('summaryBar').innerHTML = `
    <div class="summaryTile primary">
      <div class="t">Gesamtergebnis</div>
      <div class="v">${label}: ${formatEUR(deltaAbs)} €</div>
      <div class="s">Kosten ${formatEUR(totals.kosten)} € • Abschläge ${formatEUR(totals.abschlag)} €</div>
    </div>
    <div class="summaryTile">
      <div class="t">Kosten gesamt</div>
      <div class="v">${formatEUR(totals.kosten)} €</div>
      <div class="s">Arbeit ${formatEUR(totals.work)} € • Grund/Service ${formatEUR(totals.base)} €</div>
    </div>
    ${isIncluded('gas') ? `
    <div class="summaryTile">
      <div class="t">Gas‑Umrechnung</div>
      <div class="v">${gasFactor().toFixed(4)} kWh/m³</div>
      <div class="s">Brennwert ${Number(gasBrennwert.value).toFixed(3)} • Zustandszahl ${Number(gasZustand.value).toFixed(3)}</div>
    </div>` : ''}
  `;

  // cards
  document.getElementById('resultCards').innerHTML = resources.map(res=>`
    <div class="miniCard">
      <h3>${sectionName(res.prefix)}</h3>
      <div class="kpis">
        <span class="kpi"><strong>${res.totalCons.toFixed(2)}</strong> ${res.unit}</span>
        <span class="kpi">${mode()==='daily'?res.totalDays+' Tage':res.totalMonths+' Monate'}</span>
      </div>
      <div class="line"><span>Arbeit</span><strong>${formatEUR(res.workCost)} €</strong></div>
      <div class="line"><span>Grund/Service</span><strong>${formatEUR(res.baseCost)} €</strong></div>
      <div class="line"><span>Abschläge</span><strong>${formatEUR(res.abschlagGes)} €</strong></div>
      <div style="margin-top:10px">${badge(res.delta)}</div>
    </div>
  `).join('');

  // totals table
  document.getElementById('totalsTableWrap').innerHTML = `
    <table class="std">
      <thead>
        <tr>
          <th>Bereich</th>
          <th class="num">Arbeit</th>
          <th class="num">Grund/Service</th>
          <th class="num">Kosten</th>
          <th class="num">Abschläge</th>
          <th>Ergebnis</th>
        </tr>
      </thead>
      <tbody>
        ${resources.map(r=>`
          <tr>
            <td><strong>${sectionName(r.prefix)}</strong></td>
            <td class="num">${formatEUR(r.workCost)} €</td>
            <td class="num">${formatEUR(r.baseCost)} €</td>
            <td class="num">${formatEUR(r.kosten)} €</td>
            <td class="num">${formatEUR(r.abschlagGes)} €</td>
            <td>${badge(r.delta)}</td>
          </tr>
        `).join('')}
        <tr>
          <td><strong>Summe</strong></td>
          <td class="num"><strong>${formatEUR(totals.work)} €</strong></td>
          <td class="num"><strong>${formatEUR(totals.base)} €</strong></td>
          <td class="num"><strong>${formatEUR(totals.kosten)} €</strong></td>
          <td class="num"><strong>${formatEUR(totals.abschlag)} €</strong></td>
          <td><strong>${badge(totals.delta)}</strong></td>
        </tr>
      </tbody>
    </table>
  `;

  // tariff details
  document.getElementById('tariffDetails').innerHTML = resources.map(buildTariffSummary).join('');

  setResultVisible(true);
  document.getElementById('pdfBtn').style.display = 'inline-block';
}

/* ==================== PDF ==================== */
function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'mm', format:'a4' });

  const prefixes = ['gas','strom','wasser'].filter(isIncluded);
  const resources = prefixes.map(p=>calcResource(p));

  const marginX = 12;
  let y = 16;

  doc.setFontSize(16);
  doc.text('Nebenkosten‑Report (v5)', 105, y, { align:'center' });
  y += 8;

  doc.setFontSize(10);
  doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, marginX, y);
  doc.text(`Modus: ${mode()==='daily'?'tagegenau':'Monatslogik'}`, 200 - marginX, y, { align:'right' });
  y += 6;
  if (isIncluded('gas')){
    doc.text(`Brennwert: ${Number(gasBrennwert.value).toFixed(3)}  Zustandszahl: ${Number(gasZustand.value).toFixed(3)}`, marginX, y);
    y += 6;
    doc.text(`Gas‑Faktor: ${gasFactor().toFixed(4)} kWh/m³`, marginX, y);
    y += 8;
  } else {
    y += 2;
  }

  const spanLabel = mode()==='daily'?'Tage':'Monate';
  const rows = resources.map(r=>[
    sectionName(r.prefix),
    `${r.totalCons.toFixed(2)} ${r.unit}`,
    String(mode()==='daily'?r.totalDays:r.totalMonths),
    `${formatEUR(r.workCost)} €`,
    `${formatEUR(r.baseCost)} €`,
    `${formatEUR(r.kosten)} €`,
    `${formatEUR(r.abschlagGes)} €`
  ]);

  const totalsKosten = resources.reduce((a,r)=>a+r.kosten,0);
  const totalsAbschl = resources.reduce((a,r)=>a+r.abschlagGes,0);
  const totalsDelta = totalsKosten - totalsAbschl;

  const colW = [22, 34, 14, 22, 24, 22, 22];
  const headers = ['Bereich','Verbrauch',spanLabel,'Arbeit','Grund','Kosten','Abschl.'];

  function newPageIfNeeded(extra){
    if (y + extra > 287){ doc.addPage(); y = 16; }
  }
  function cellText(text, x, y, w){
    const lines = doc.splitTextToSize(String(text), w-2);
    doc.text(lines, x+1, y+4);
    return lines.length;
  }

  newPageIfNeeded(12);
  doc.setFontSize(10);
  let x = marginX;
  doc.setFont(undefined,'bold');
  headers.forEach((h,i)=>{
    doc.rect(x, y, colW[i], 8);
    doc.text(h, x+1, y+5.5);
    x += colW[i];
  });
  doc.setFont(undefined,'normal');
  y += 8;

  rows.forEach(r=>{
    const heights = r.map((txt,i)=>doc.splitTextToSize(String(txt), colW[i]-2).length);
    const rowH = Math.max(...heights)*5.2 + 2;
    newPageIfNeeded(rowH+2);

    let xx = marginX;
    for (let i=0;i<r.length;i++){
      doc.rect(xx, y, colW[i], rowH);
      cellText(r[i], xx, y, colW[i]);
      xx += colW[i];
    }
    y += rowH;
  });

  y += 6;
  newPageIfNeeded(20);
  doc.setFont(undefined,'bold');
  doc.text(`Gesamtkosten: ${formatEUR(totalsKosten)} €`, marginX, y); y += 6;
  doc.text(`Gesamte Abschläge: ${formatEUR(totalsAbschl)} €`, marginX, y); y += 8;
  const label = totalsDelta>0 ? 'Gesamtnachzahlung' : totalsDelta<0 ? 'Gesamtrückerstattung' : 'Gesamt';
  doc.text(`${label}: ${formatEUR(Math.abs(totalsDelta))} €`, marginX, y);
  doc.setFont(undefined,'normal');

  doc.save('Nebenkosten-Report-v5.pdf');
}

/* ==================== Tabs ==================== */
function setActiveTab(prefix){
  const tabs = ['gas','strom','wasser'];
  tabs.forEach(t=>{
    const btn = document.getElementById('tab-'+t);
    const panel = document.getElementById('panel-'+t);
    const active = (t===prefix);
    btn.setAttribute('aria-selected', active ? 'true' : 'false');
    panel.classList.toggle('active', active);
  });
  // keep focus nice
  document.getElementById('tab-'+prefix).focus({preventScroll:true});
}

/* ==================== Storage ==================== */
function saveState(){
  const state = { inputs:{}, tariffs:{}, mode: mode(), activeTab: currentTab };
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if (!el.id) return;
    state.inputs[el.id] = (el.type === 'checkbox') ? el.checked : el.value;
  });
  ['gas','strom','wasser'].forEach(p=>{
    state.tariffs[p] = readTariffs(p).map(t=>({ from:t.from||'', to:t.to||'', arbeit:t.arbeit, grund:t.grund, service:t.service||0 }));
  });
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
}

/* ==================== Export / Import ==================== */
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

function shallowClone(obj){
  return JSON.parse(JSON.stringify(obj));
}

function exportFilteredState(state, scope){
  if(scope === "all") return state;

  const prefixes = ["gas","strom","wasser"];
  const keepPrefix = scope;

  const s = shallowClone(state);

  // inputs: keep global + selected prefix, drop other prefixes
  if(s.inputs && typeof s.inputs === "object"){
    const out = {};
    const isOtherPrefixKey = (k)=> prefixes.some(p=> p!==keepPrefix && k.startsWith(p));
    Object.keys(s.inputs).forEach(k=>{
      if(!isOtherPrefixKey(k)) out[k] = s.inputs[k];
    });
    // also force include toggles to match scope (if present)
    out["inc-gas"] = (keepPrefix==="gas");
    out["inc-strom"] = (keepPrefix==="strom");
    out["inc-wasser"] = (keepPrefix==="wasser");
    s.inputs = out;
  }

  // tariffs: keep only selected prefix if present
  if(s.tariffs && typeof s.tariffs === "object"){
    s.tariffs = { [keepPrefix]: s.tariffs[keepPrefix] || [] };
  }

  return s;
}

function exportData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const state = raw ? JSON.parse(raw) : null;
    if(!state){
      toast("Keine gespeicherten Daten gefunden.");
      return;
    }

    const scopeEl = document.getElementById("exportScope");
    const scope = scopeEl ? scopeEl.value : "all";
    const filtered = exportFilteredState(state, scope);

    const payload = {
      app: "Nebenkostenrechner",
      version: "v5_modern",
      exportedAt: new Date().toISOString(),
      storageKey: STORAGE_KEY,
      scope,
      state: filtered
    };

    const date = new Date().toISOString().slice(0,10);
    const suffix = scope==="all" ? "Gesamt" : scope;
    downloadJSON(`Nebenkosten_Export_${date}_${suffix}.json`, payload);
  }catch(e){
    console.error(e);
    toast("Export fehlgeschlagen.");
  }
}

function isValidImportPayload(obj){
  if(!obj) return false;
  // allow both full payload and raw state
  if(obj.state && typeof obj.state === "object") return true;
  if(obj.inputs && typeof obj.inputs === "object") return true;
  return false;
}

function applyImportedState(obj){
  const state = obj.state && typeof obj.state === "object" ? obj.state : obj;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function importDataFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result || ""));
      if(!isValidImportPayload(obj)){
        toast("Datei sieht nicht nach einem gültigen Export aus.");
        return;
      }

      const ok = confirm("Import überschreibt deine aktuell gespeicherten Daten in diesem Browser. Fortfahren?");
      if(!ok){
        toast("Import abgebrochen.");
        return;
      }

      applyImportedState(obj);
      toast("Import erfolgreich. Seite wird neu geladen…");
      setTimeout(()=> location.reload(), 250);
    }catch(e){
      console.error(e);
      toast("Import fehlgeschlagen (ungültiges JSON).");
    }
  };
  reader.onerror = () => toast("Import fehlgeschlagen.");
  reader.readAsText(file);
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const state = JSON.parse(raw);

    if (state.mode){
      const m = document.getElementById('calcMode');
      if (m) m.value = state.mode;
    }
    if (state.inputs){
      Object.keys(state.inputs).forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'checkbox') el.checked = !!state.inputs[id];
        else el.value = state.inputs[id];
      });
    }
    if (state.tariffs){
      ['gas','strom','wasser'].forEach(p=>{
        const tbody = document.getElementById(p+'Tariffs');
        if (!tbody) return;
        tbody.innerHTML = '';
        const arr = state.tariffs[p];
        if (Array.isArray(arr) && arr.length){
          arr.forEach(t=>addTariff(p, t));
        } else {
          addTariff(p, {});
        }
      });
    }
    if (state.activeTab){
      currentTab = state.activeTab;
    }
  }catch(e){}
}

/* ==================== Messpunkte UI ==================== */
function renderReadingsTable(prefix){
  const tbody = document.getElementById(prefix+'ReadingsTbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const readings = readReadingsJSON(prefix);

  const unit = (prefix==='wasser') ? 'm³' : (prefix==='gas' ? 'm³' : 'kWh');

  readings.sort((a,b)=> (a.date||'').localeCompare(b.date||'')).forEach(r=>{
    addReadingRow(prefix, r.date, r.value, r.note || '', false);
  });

  // If empty: show helper row (optional)
  if(!readings.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" class="small" style="opacity:.8">Noch keine Messpunkte. Klick auf “+ Messpunkt” oder konvertiere Start/Ende.</td>`;
    tbody.appendChild(tr);
  }
}

function addReadingRow(prefix, dateVal='', valueVal='', noteVal='', sync=true){
  const tbody = document.getElementById(prefix+'ReadingsTbody');
  if(!tbody) return;

  // remove helper row if present
  const helper = tbody.querySelector('tr td[colspan="4"]');
  if(helper) helper.closest('tr')?.remove();

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="date" value="${dateVal || ''}"></td>
    <td class="num"><input type="number" step="0.01" value="${(valueVal ?? '')}"></td>
    <td><input type="text" value="${(noteVal ?? '').replaceAll('"','&quot;')}"></td>
    <td class="num"><button type="button" class="ghost delBtn">✕</button></td>
  `;
  tbody.appendChild(tr);

  tr.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', ()=> syncReadings(prefix));
  });
  tr.querySelector('.delBtn').addEventListener('click', ()=>{
    tr.remove();
    syncReadings(prefix);
    renderReadingsTable(prefix); // ensure helper row if empty
  });

  if(sync) syncReadings(prefix);
}

function setModeUI(prefix){
  const mode = getInputMode(prefix);
  const simpleBox = document.getElementById(prefix+'SimpleBox');
  const readingsBox = document.getElementById(prefix+'ReadingsBox');
  if(simpleBox) simpleBox.style.display = (mode==='simple') ? '' : 'none';
  if(readingsBox) readingsBox.style.display = (mode==='readings') ? '' : 'none';
}

function convertSimpleToReadings(prefix){
  const s = readSimpleSection(prefix);
  if(!s?.datumAlt || !s?.datumNeu) return;
  const arr = [
    { date: s.datumAlt, value: s.alt, note:'Start' },
    { date: s.datumNeu, value: s.neu, note:'Ende' }
  ];
  writeReadingsJSON(prefix, arr);
  renderReadingsTable(prefix);
  document.getElementById(prefix+'InputMode').value = 'readings';
  setModeUI(prefix);
  saveState();
  ['gas','strom','wasser'].forEach(renderPreview);
}

function convertReadingsToSimple(prefix){
  const r = readReadingsJSON(prefix).sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  if(r.length < 2) return;
  const first = r[0], last = r[r.length-1];
  document.getElementById(prefix+'AltDatum').value = first.date;
  document.getElementById(prefix+'Alt').value = first.value;
  document.getElementById(prefix+'NeuDatum').value = last.date;
  document.getElementById(prefix+'Neu').value = last.value;

  document.getElementById(prefix+'InputMode').value = 'simple';
  setModeUI(prefix);
  saveState();
  ['gas','strom','wasser'].forEach(renderPreview);
}

function initModesAndReadings(){
  ['gas','strom','wasser'].forEach(prefix=>{
    // default mode
    const sel = document.getElementById(prefix+'InputMode');
    if(sel){
      sel.addEventListener('change', ()=>{
        setModeUI(prefix);
        saveState();
        ['gas','strom','wasser'].forEach(renderPreview);
      });
    }

    // ensure readings JSON exists (no-op)
    if(!document.getElementById(prefix+'ReadingsJSON')?.value){
      writeReadingsJSON(prefix, readReadingsJSON(prefix));
    }
    renderReadingsTable(prefix);
    setModeUI(prefix);

    // buttons
    document.querySelectorAll(`button[data-add-reading="${prefix}"]`).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        addReadingRow(prefix, new Date().toISOString().slice(0,10), '', '', true);
      });
    });
    document.querySelectorAll(`button[data-convert-simple="${prefix}"]`).forEach(btn=>{
      btn.addEventListener('click', ()=> convertSimpleToReadings(prefix));
    });
    document.querySelectorAll(`button[data-convert-readings="${prefix}"]`).forEach(btn=>{
      btn.addEventListener('click', ()=> convertReadingsToSimple(prefix));
    });
  });
}


function resetState(){
  if (!confirm('Wirklich alles zurücksetzen?')) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

/* ==================== Wiring ==================== */
function setTodayIfEmpty(){
  const iso = fmtISO(new Date());
  ['gas','strom','wasser'].forEach(p=>{
    const el = document.getElementById(p+'NeuDatum');
    if (el && !el.value) el.value = iso;
  });
}


function applyPreset(prefix, preset){
  const tbody = document.getElementById(prefix+'Tariffs');
  if (!tbody) return;
  ensureAtLeastOneTariff(prefix);
  const first = tbody.querySelector('tr');
  if (!first) return;

  const set = (role, val)=>{
    const inp = first.querySelector(`input[data-role="${role}"]`);
    if (inp){ inp.value = val; validateNonNegative(inp); }
  };

  if (preset === 'gas-typisch'){
    set('arbeit', 0.1070);
    set('grund', 14.00);
  }
  if (preset === 'strom-typisch'){
    set('arbeit', 0.3340);
    set('grund', 12.00);
  }
  if (preset === 'wasser-mit-service'){
    set('arbeit', 1.99);
    set('grund', 112.50);
    set('service', 34.04);
  }

  saveState();
  validateTariffs(prefix);
  renderPreview(prefix);
}
function wirePresetButtons(){
  document.querySelectorAll('button[data-preset]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-preset');
      const prefix = key.split('-')[0];
      applyPreset(prefix, key);
      hideNotice();
    });
  });
}

function openTariffSwitch(prefix){
  const box = document.getElementById('switch-'+prefix);
  if (!box) return;
  box.hidden = false;

  const last = readTariffs(prefix).slice(-1)[0] || {};
  const d = document.getElementById(prefix+'SwitchDate');
  const a = document.getElementById(prefix+'SwitchArbeit');
  const g = document.getElementById(prefix+'SwitchGrund');
  const s = document.getElementById(prefix+'SwitchService');
  if (a && !a.value) a.value = (last.arbeit ?? '').toString();
  if (g && !g.value) g.value = (last.grund ?? '').toString();
  if (s && !s.value) s.value = (last.service ?? '').toString();

  if (d && !d.value){
    const alt = document.getElementById(prefix+'AltDatum')?.value;
    if (alt){
      const dd = addDays(parseDate(alt), 1);
      d.value = fmtISO(dd);
    }
  }
}
function closeTariffSwitch(prefix){
  const box = document.getElementById('switch-'+prefix);
  if (box) box.hidden = true;
  const err = document.getElementById('err-'+prefix+'SwitchDate');
  if (err) err.textContent = '';
}

function applyTariffSwitch(prefix){
  const dateEl = document.getElementById(prefix+'SwitchDate');
  const err = document.getElementById('err-'+prefix+'SwitchDate');
  const dateISO = dateEl?.value;
  if (!dateISO){ if (err) err.textContent = 'Bitte ein Datum wählen'; return; }

  const altISO = document.getElementById(prefix+'AltDatum')?.value;
  const neuISO = document.getElementById(prefix+'NeuDatum')?.value;
  const s = parseDate(altISO), e = parseDate(neuISO), d = parseDate(dateISO);
  if (!s || !e || !d || d <= s || d >= e){
    if (err) err.textContent = 'Datum muss im Messzeitraum liegen (nach alt, vor neu).';
    return;
  }
  if (err) err.textContent = '';

  const newArbeit = Number(document.getElementById(prefix+'SwitchArbeit')?.value);
  const newGrund  = Number(document.getElementById(prefix+'SwitchGrund')?.value);
  const newService= Number(document.getElementById(prefix+'SwitchService')?.value);

  if (!Number.isFinite(newArbeit) || newArbeit < 0){ showNotice(['Neuer Arbeitspreis ist nicht plausibel.']); return; }
  if (!Number.isFinite(newGrund) || newGrund < 0){ showNotice(['Neuer Grundpreis ist nicht plausibel.']); return; }
  if (prefix==='wasser' && (!Number.isFinite(newService) || newService < 0)){ showNotice(['Neuer Service ist nicht plausibel.']); return; }

  const tbody = document.getElementById(prefix+'Tariffs');
  ensureAtLeastOneTariff(prefix);
  const rows = Array.from(tbody.querySelectorAll('tr'));

  const periodFrom = parseDate(altISO);
  const periodTo = parseDate(neuISO);

  const getRowDates = (tr)=>{
    const f = tr.querySelector('input[data-role="from"]')?.value || '';
    const t = tr.querySelector('input[data-role="to"]')?.value || '';
    const rf = f ? parseDate(f) : periodFrom;
    const rt = t ? parseDate(t) : periodTo;
    return { f, t, rf, rt };
  };

  let target = null;
  for (const tr of rows){
    const {rf, rt} = getRowDates(tr);
    if (!rf || !rt) continue;
    if (d >= rf && d < rt){ target = tr; break; }
  }

  if (!target){
    addTariff(prefix, { from: dateISO, to:'', arbeit:newArbeit, grund:newGrund, service: prefix==='wasser'?newService:0 });
    saveState(); validateTariffs(prefix); renderPreview(prefix);
    closeTariffSwitch(prefix);
    return;
  }

  const { t:oldToISO, rf } = getRowDates(target);

  if (fmtISO(rf) === dateISO){
    const setVal = (role, val)=>{
      const inp = target.querySelector(`input[data-role="${role}"]`);
      if (inp) inp.value = val;
    };
    setVal('arbeit', newArbeit);
    setVal('grund', newGrund);
    if (prefix==='wasser') setVal('service', newService);
    saveState(); validateTariffs(prefix); renderPreview(prefix);
    closeTariffSwitch(prefix);
    return;
  }

  const toInp = target.querySelector('input[data-role="to"]');
  if (toInp) toInp.value = dateISO;

  addTariff(prefix, { from: dateISO, to: oldToISO || '', arbeit:newArbeit, grund:newGrund, service: prefix==='wasser'?newService:0 });

  saveState(); validateTariffs(prefix); renderPreview(prefix);
  closeTariffSwitch(prefix);
}

function wireTariffSwitch(){
  document.querySelectorAll('button[data-tariff-switch-open]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const p = btn.getAttribute('data-tariff-switch-open');
      openTariffSwitch(p);
    });
  });
  document.querySelectorAll('button[data-cancel-switch]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const p = btn.getAttribute('data-cancel-switch');
      closeTariffSwitch(p);
    });
  });
  document.querySelectorAll('button[data-apply-switch]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const p = btn.getAttribute('data-apply-switch');
      applyTariffSwitch(p);
    });
  });
}

function wireIncludeToggles(){
  ['gas','strom','wasser'].forEach(p=>{
    const cb = document.getElementById('inc-'+p);
    if (!cb) return;
    cb.addEventListener('change', ()=>{
      applyIncludeUI();
      saveState();
      ['gas','strom','wasser'].forEach(renderPreview);
      hideNotice();
    });
  });
}

function wireTariffButtons(){
  document.querySelectorAll('button[data-add-tariff]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const p = btn.getAttribute('data-add-tariff');
      const last = readTariffs(p).slice(-1)[0];
      addTariff(p, last ? { ...last, from:'', to:'' } : {});
      renderPreview(p);
    });
  });

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-remove-tariff]');
    if (!btn) return;
    const p = btn.getAttribute('data-remove-tariff');
    removeTariff(p, btn);
    renderPreview(p);
  });

  ['gas','strom','wasser'].forEach(p=>{
    const tbody = document.getElementById(p+'Tariffs');
    tbody.addEventListener('input', ()=>{
      saveState();
      validateTariffs(p);
      renderPreview(p);
    });
  });
}

let currentTab = 'gas';

function wireTabs(){
  ['gas','strom','wasser'].forEach(p=>{
    document.getElementById('tab-'+p).addEventListener('click', ()=>{
      currentTab = p;
      setActiveTab(p);
      saveState();
    });
  });

  // keyboard support
  document.querySelectorAll('.tabBtn').forEach(btn=>{
    btn.addEventListener('keydown', (e)=>{
      if (!['ArrowLeft','ArrowRight'].includes(e.key)) return;
      const order = ['gas','strom','wasser'];
      const idx = order.indexOf(currentTab);
      const next = e.key==='ArrowRight'
        ? order[(idx+1)%order.length]
        : order[(idx-1+order.length)%order.length];
      currentTab = next;
      setActiveTab(next);
      saveState();
    });
  });
}

function wire(){
  document.querySelectorAll('input[type=number]').forEach(el=>{
    el.addEventListener('input', ()=>{
      validateNonNegative(el);
      updateGasFactor();
      saveState();
      ['gas','strom','wasser'].forEach(renderPreview);
      hideNotice();
    });
  });
  document.querySelectorAll('input[type=date]').forEach(el=>{
    el.addEventListener('input', ()=>{
      saveState();
      ['gas','strom','wasser'].forEach(renderPreview);
      hideNotice();
    });
  });
  document.getElementById('calcMode').addEventListener('change', ()=>{
    document.getElementById('modeChip').textContent = (mode()==='daily'?'Tagegenau':'Monatslogik');
    saveState();
    ['gas','strom','wasser'].forEach(renderPreview);
  });

  ['gas','strom','wasser'].forEach(p=>{
    ['Alt','Neu','AltDatum','NeuDatum'].forEach(s=>{
      const el = document.getElementById(p+s);
      if (!el) return;
      el.addEventListener('input', ()=>{
        validateMeterPair(p);
        validateDatePair(p);
      });
    });
  });

  document.getElementById('calcBtn').addEventListener('click', calculate);
  document.getElementById('pdfBtn').addEventListener('click', ()=>{
    if (!validateAll()) return;
    generatePDF();
  });
  document.getElementById('resetBtn').addEventListener('click', resetState);

/* Export / Import buttons */
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

if(exportBtn) exportBtn.addEventListener("click", exportData);
if(importBtn && importFile){
  importBtn.addEventListener("click", ()=> importFile.click());
  importFile.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importDataFromFile(f);
    importFile.value = "";
  });
}
}


/* ==================== Themes ==================== */
const THEME_KEY = "nk_theme_v6";
const THEMES = [
  {id:"neo",    name:"Neo",    desc:"Modern & bunt (Default)", sw:["--primary","--primary2","--pink","--amber"]},
  {id:"ice",    name:"Ice",    desc:"Clean & frisch (Light)",   sw:["--primary","--primary2","--bg0","--text"]},
  {id:"dark",   name:"Dark",   desc:"Deep Dark",               sw:["--primary","--primary2","--bg0","--text"]},
  {id:"pastel", name:"Pastel", desc:"Soft & friendly",         sw:["--primary","--primary2","--pink","--amber"]},
  {id:"sunset", name:"Sunset", desc:"Warm & kontrastreich",    sw:["--primary","--primary2","--pink","--amber"]},
  {id:"mono",   name:"Mono",   desc:"Minimal monochrom",       sw:["--primary","--primary2","--bg0","--text"]},
];

function setTheme(id){
  document.documentElement.setAttribute("data-theme", id);
  try{ localStorage.setItem(THEME_KEY, id); }catch(e){}
}
function getTheme(){
  try{ return localStorage.getItem(THEME_KEY) || "neo"; }catch(e){ return "neo"; }
}
function buildThemePanel(){
  const panel = document.getElementById("themePanel");
  const grid = panel.querySelector(".themeGrid");
  grid.innerHTML = THEMES.map(t=>{
    return `
      <button type="button" class="themeChoice" data-theme="${t.id}">
        <div class="name">${t.name}</div>
        <div class="desc">${t.desc}</div>
        <div class="swatches">
          ${t.sw.map(v=>{
            const c = getComputedStyle(document.documentElement).getPropertyValue(v).trim() || "rgba(255,255,255,.35)";
            return `<span class="sw" style="background:${c}"></span>`;
          }).join("")}
        </div>
      </button>
    `;
  }).join("");

  // highlight active
  const active = document.documentElement.getAttribute("data-theme") || "neo";
  grid.querySelectorAll(".themeChoice").forEach(btn=>{
    const on = btn.getAttribute("data-theme") === active;
    btn.style.borderColor = on ? "rgba(124,92,255,.55)" : "rgba(255,255,255,.14)";
    btn.style.background = on ? "linear-gradient(135deg, rgba(124,92,255,.22), rgba(45,212,191,.10))" : "rgba(255,255,255,.06)";
  });

  grid.addEventListener("click", (e)=>{
    const btn = e.target.closest(".themeChoice");
    if (!btn) return;
    const id = btn.getAttribute("data-theme");
    setTheme(id);
    // rebuild swatches + highlight
    buildThemePanel();
    saveState(); // keep in sync with other storage
  }, { once:false });
}

function openThemePanel(){
  const btn = document.getElementById("themeBtn");
  const panel = document.getElementById("themePanel");
  buildThemePanel();
  panel.style.display = "block";
  btn.setAttribute("aria-expanded", "true");
  btn.dataset.open = "true";
}
function closeThemePanel(){
  const btn = document.getElementById("themeBtn");
  const panel = document.getElementById("themePanel");
  panel.style.display = "none";
  btn.setAttribute("aria-expanded", "false");
  btn.dataset.open = "false";
}
function wireTheme(){
  const btn = document.getElementById("themeBtn");
  const panel = document.getElementById("themePanel");
  const closeBtn = document.getElementById("themeClose");

  btn.addEventListener("click", ()=>{
    const isOpen = panel.style.display === "block";
    if (isOpen) closeThemePanel();
    else openThemePanel();
  });

  closeBtn.addEventListener("click", closeThemePanel);

  // click outside
  document.addEventListener("mousedown", (e)=>{
    if (panel.style.display !== "block") return;
    const inside = panel.contains(e.target) || btn.contains(e.target);
    if (!inside) closeThemePanel();
  });

  // escape
  document.addEventListener("keydown", (e)=>{
    if (e.key !== "Escape") return;
    if (panel.style.display === "block") closeThemePanel();
  });
}

/* Init */
setTheme(getTheme());
['gas','strom','wasser'].forEach(p=>ensureAtLeastOneTariff(p));
loadState();
initModesAndReadings();
setTodayIfEmpty();
updateGasFactor();
wireTariffButtons();
wirePresetButtons();
wireTariffSwitch();
wireIncludeToggles();
applyIncludeUI();
wireTabs();
wireTheme();
setActiveTab(currentTab);
wire();
['gas','strom','wasser'].forEach(renderPreview);
document.getElementById('modeChip').textContent = (mode()==='daily'?'Tagegenau':'Monatslogik');
document.getElementById('factorChip').textContent = `Gas‑Faktor: ${document.getElementById('gasFactor').value || '–'}`;
/* ===== Messpunkte einklappbar (Variante B) ===== */
function getReadingsCount(prefix){
  const tbody = document.getElementById(prefix + "ReadingsTbody");
  if(!tbody) return 0;
  return tbody.children ? tbody.children.length : 0;
}
function updateReadingsUI(prefix){
  const count = getReadingsCount(prefix);
  const countEl = document.getElementById(prefix + "ReadingsCount");
  if(countEl) countEl.textContent = String(count);

  const body = document.getElementById(prefix + "ReadingsBody");
  const toggle = document.querySelector(`[data-toggle-readings="${prefix}"]`);
  if(toggle){
    const open = body && !body.classList.contains("collapsed");
    toggle.textContent = open ? "Messpunkte ausblenden" : "Messpunkte anzeigen";
  }
}
function openReadings(prefix){
  const body = document.getElementById(prefix + "ReadingsBody");
  if(body) body.classList.remove("collapsed");
  updateReadingsUI(prefix);
}
function toggleReadings(prefix){
  const body = document.getElementById(prefix + "ReadingsBody");
  if(!body) return;
  body.classList.toggle("collapsed");
  updateReadingsUI(prefix);
}
function updateAllReadings(){
  ["gas","strom","wasser"].forEach(updateReadingsUI);
}

document.addEventListener("click", (e)=>{
  const t = e.target;

  const toggleBtn = t.closest && t.closest("[data-toggle-readings]");
  if(toggleBtn){
    toggleReadings(toggleBtn.getAttribute("data-toggle-readings"));
    return;
  }

  // Auto-open when adding or converting
  const addBtn = t.closest && t.closest("[data-add-reading]");
  if(addBtn){
    openReadings(addBtn.getAttribute("data-add-reading"));
    setTimeout(()=> updateAllReadings(), 80);
    return;
  }
  const conv1 = t.closest && t.closest("[data-convert-simple]");
  if(conv1){
    openReadings(conv1.getAttribute("data-convert-simple"));
    setTimeout(()=> updateAllReadings(), 120);
    return;
  }
  const conv2 = t.closest && t.closest("[data-convert-readings]");
  if(conv2){
    openReadings(conv2.getAttribute("data-convert-readings"));
    setTimeout(()=> updateAllReadings(), 120);
    return;
  }
});

// Keep counts fresh after any render-like action
window.addEventListener("load", ()=>{
  updateAllReadings();
});

// Also update after deleting a row (trash buttons are inside tbody)
document.addEventListener("input", (e)=>{
  const el = e.target;
  if(!el || !el.closest) return;
  if(el.closest("#gasReadingsBox") || el.closest("#stromReadingsBox") || el.closest("#wasserReadingsBox")){
    setTimeout(()=> updateAllReadings(), 0);
  }
});


/* ===== Schnelleingabe einklappbar ===== */
function updateSimpleToggle(prefix){
  const body = document.getElementById(prefix + "SimpleBody");
  const btn = document.querySelector(`[data-toggle-simple="${prefix}"]`);
  if(!btn || !body) return;
  const open = !body.classList.contains("collapsed");
  btn.textContent = open ? "Schnelleingabe ausblenden" : "Schnelleingabe anzeigen";
}
function toggleSimple(prefix){
  const body = document.getElementById(prefix + "SimpleBody");
  if(!body) return;
  body.classList.toggle("collapsed");
  updateSimpleToggle(prefix);
}
function setSimpleCollapsed(prefix, collapsed){
  const body = document.getElementById(prefix + "SimpleBody");
  if(!body) return;
  body.classList.toggle("collapsed", !!collapsed);
  updateSimpleToggle(prefix);
}
window.addEventListener("load", ()=>{
  ["gas","strom","wasser"].forEach(updateSimpleToggle);
});

document.addEventListener("click", (e)=>{
  const btn = e.target.closest && e.target.closest("[data-toggle-simple]");
  if(btn){
    toggleSimple(btn.getAttribute("data-toggle-simple"));
  }
});

// Wenn Nutzer auf „Messpunkte anzeigen“ oder „+ Messpunkt“ klickt, kann Schnelleingabe optional einklappen
document.addEventListener("click", (e)=>{
  const add = e.target.closest && e.target.closest("[data-add-reading]");
  if(add){
    const p = add.getAttribute("data-add-reading");
    setSimpleCollapsed(p, true);
  }
  const tgl = e.target.closest && e.target.closest("[data-toggle-readings]");
  if(tgl){
    const p = tgl.getAttribute("data-toggle-readings");
    // sobald Messpunkte geöffnet werden, Schnelleingabe einklappen
    const body = document.getElementById(p + "ReadingsBody");
    if(body && !body.classList.contains("collapsed")){
      setSimpleCollapsed(p, true);
    }
  }
});


/* ===== Stickybar Toggle + Dynamic Spacing ===== */
function setStickySpacing(){
  const bar = document.querySelector('.stickyBar');
  if(!bar) return;
  const hidden = bar.classList.contains('isHidden');
  const h = hidden ? 0 : Math.ceil(bar.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--stickyH', h + 'px');
}

function setStickyHidden(hidden){
  const bar = document.querySelector('.stickyBar');
  const showBtn = document.getElementById('stickyShow');
  const toggleBtn = document.getElementById('stickyToggle');
  if(!bar) return;

  bar.classList.toggle('isHidden', !!hidden);
  if(showBtn) showBtn.style.display = hidden ? 'block' : 'none';
  if(toggleBtn) toggleBtn.textContent = hidden ? 'Leiste anzeigen' : 'Leiste ausblenden';

  try{ localStorage.setItem('nk_sticky_hidden', hidden ? '1':'0'); }catch(e){}
  setStickySpacing();
}

window.addEventListener('load', ()=>{
  const bar = document.querySelector('.stickyBar');
  if(!bar) return;

  let hidden = false;
  try{ hidden = localStorage.getItem('nk_sticky_hidden') === '1'; }catch(e){}
  setStickyHidden(hidden);

  const toggleBtn = document.getElementById('stickyToggle');
  const showBtn = document.getElementById('stickyShow');
  if(toggleBtn){
    toggleBtn.addEventListener('click', ()=>{
      setStickyHidden(!bar.classList.contains('isHidden'));
    });
  }
  if(showBtn){
    showBtn.addEventListener('click', ()=> setStickyHidden(false));
  }

  window.addEventListener('resize', ()=> setTimeout(setStickySpacing, 60));
  document.addEventListener('click', ()=> setTimeout(setStickySpacing, 80));
});
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
</script>

</body>
</html>
